function bulletRanges(t){return t.ranges}function bulletMarkers(t){return t.markers}function bulletMeasures(t){return t.measures}function bulletTranslate(t){return function(e){return"translate("+t(e)+",0)"}}function bulletWidth(t){var e=t(0);return function(a){return Math.abs(t(a)-e)}}var Constants=Constants||{};Constants.API_METADATA_URL="//api.smartdatanet.it/metadataapi/api/",Constants.API_DATA_URL="//api.smartdatanet.it/api/",Constants.SDP_WEB_SOCKET_BASE_URL="wss://stream.smartdatanet.it/wss/",Constants.WEB_SOCKET_USER="guest",Constants.WEB_SOCKET_SECRET="Aekieh6F",Constants.SDP_WEBSOCKET_CONNECTING="Connecting",Constants.SDP_WEBSOCKET_CONNECTED="Connected",Constants.SDP_WEBSOCKET_NOT_CONNECTED="Not Connected",Constants.LINE_CHART_COLORS=["#004586","#0084d1","#d01e2a","#f37a1f","#f3c414","#3d9e00","#a6d615","#8f69c2","#e4477e"],Constants.Time={},Constants.Time.ONE_MINUTE=6e4,Constants.Time.ONE_HOUR=36e5,Constants.Time.ONE_DAY=864e5,Constants.Time.ONE_MONTH=26784e5,Constants.Time.ONE_YEAR=31536e6,Constants.MAP_TILES_CARTO_DB_POSITRON_URL="http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png",angular.module("yucca.plugin",["yucca.widgets","yucca.utils","yucca.filters"]);var yuccaWidgetsTemplatesModule=angular.module("yucca.widgets.templates",["yucca.utils"]),yuccaWidgetsModule=angular.module("yucca.widgets",["yucca.widgets.templates","yucca.services","nvd3","leaflet-directive"]),yuccaWidgetsFilter=angular.module("yucca.filters",[]);yuccaWidgetsFilter.filter("safeNumber",function(){return function(t,e,a){var n=t,r="";return isNaN(t)||(isNaN(e)&&(e=0),a?(n=t.toFixed(2).replace(/(\d)(?=(\d{3})+\.)/g,"$1,"),r=" €"):n=t.toFixed(e)),n+r}}),yuccaWidgetsFilter.filter("format_big_number",function(){return function(t){console.log("input",t);var e="";return t&&(t=Number.parseFloat(t),1e3>t?e=t.toFixed(2):1e6>t?e=(t/1e3).toFixed(2)+" <span class='counter-group'>k</span>":1e9>t?e=(t/1e6).toFixed(2)+" <span class='counter-group'>M</span>":1e12>t&&(e=(t/1e9).toFixed(2)+" <span class='counter-group'>B</span>")),(""+e).replace(".",",")}});var yuccaServices=yuccaServices||angular.module("yucca.services",[]);yuccaServices.factory("metadataService",["$http","$q",function(t,e){var a={},n=function(e,a){var n={method:"GET",url:e};return a&&null!=a&&""!=a&&(n.headers={Authorization:"Bearer "+a},httpBodyRequestwithCredentials=!0),t(n)};return a.getStreamMetadata=function(t,e,a,r){var s=Constants.API_METADATA_URL+"detail/"+t+"/"+a+"/"+e+"?";return console.debug(s),n(s,r)},a.getDatasetMetadata=function(t,e,a){var r=Constants.API_METADATA_URL+"detail/"+t+"/"+e+"?";return n(r,a)},a.findMetadata=function(t,e,a,r,s){var l="http:"+Constants.API_METADATA_URL+"search/full?end=10";return"undefined"!=typeof t&&null!=t&&""!=t&&(l+="&tenant="+t),"undefined"!=typeof e&&null!=e&&""!=e&&(l+="&domain="+e),"undefined"!=typeof a&&null!=a&&""!=a&&(l+="&q="+a),"undefined"!=typeof r&&null!=r&&(l+=r?"&opendata=true":"&opendata=false"),console.debug(l),n(l,s)},a}]),yuccaServices.factory("dataService",["$http","$q","$yuccaHelpers",function(t,e,a){var n={};n.getLastValue=function(t,e,n,r,s,l){var o=this,i=a.stream.wsOutputUrl(t,e,n),c={};c.ws_url=Constants.SDP_WEB_SOCKET_BASE_URL,c.user_token=r;var d=WebsocketStompSingleton.getInstance(c);console.debug("clientSingleton",d);var u=d.getWebClient();d.addSubscription(i,s,t,l),o.onDispose=function(){u.disconnect()}};var r=function(e,a,n,r){var s="https:"+Constants.API_DATA_URL+a+"/"+e+"('"+r+"')?$format=json";s+="&callback=JSON_CALLBACK";var l={method:"GET",url:s};return n&&null!=n&&""!=n&&(l.headers={Authorization:"Bearer "+n},httpBodyRequestwithCredentials=!0),console.debug("dataUrl",s),t(l)},s=function(e,a,n,r,s,l,o){var i="https:"+Constants.API_DATA_URL+a+"/"+e+"?$format=json";console.debug("filter",r),r&&null!=r&&(i+="&$filter="+r),s&&null!=s&&(i+="&$skip="+s),i+=l&&null!=l?"&$top="+l:"&$top=30",o&&null!=o&&(i+="&$orderby="+o),i+="&callback=JSON_CALLBACK";var c={method:"GET",url:i};return n&&null!=n&&""!=n&&(c.headers={Authorization:"Bearer "+n},httpBodyRequestwithCredentials=!0),console.debug("dataUrl",i),t(c)},l=function(e,a,n,r,s,l,o,i,c){console.debug("loadDataStats",e,a,n,r,s,l,o,i,c);var d="https:"+Constants.API_DATA_URL+a+"/"+e+"?$format=json";r&&null!=r&&(d+="&timeGroupBy="+r),s&&null!=s&&(d+="&timeGroupOperators="+s),l&&null!=l&&(d+="&timeGroupFilter="+l),o&&null!=o&&(d+="&$skip="+o),d+=i&&null!=i?"&$top="+i:"&$top=1000",c&&null!=c&&(d+="&$orderby="+c),d+="&callback=JSON_CALLBACK";var u={method:"GET",url:d};return n&&null!=n&&""!=n&&(u.headers={Authorization:"Bearer "+n},httpBodyRequestwithCredentials=!0),console.debug("dataUrl",d),t(u)};return n.getMeasuresStats=function(t,e,a,n,r,s,o,i){return l("MeasuresStats",t,e,a,n,r,s,o,i)},n.getSocialFeeds=function(t,e,a,n,r,l){return s("SocialFeeds",t,e,a,n,r,l)},n.getMeasures=function(t,e,a,n,r,l){return s("Measures",t,e,a,n,r,l)},n.getDataEntities=function(t,e,a,n,r,l){return s("DataEntities",t,e,a,n,r,l)},n.getSocialFeedsStats=function(t,e,a,n,r,s,o,i){return l("SocialFeedsStats",t,e,a,n,r,s,o,i)},n.getBinariesData=function(e){return t.get(e+"?$format=json")},n.getMultipleDataEnties=function(t,a,r,s,l){l>1e4&&(l=1e4);var o=parseInt(l/1e3)+1;console.debug("numOfLoop",o);for(var i=[],c=1e3,d=0;o>d;d++)i.push(n.getDataEntities(t,a,r,d*c,c,s));return e.all(i)},n.getSingleSocialFeeds=function(t,e,a){return r("SocialFeeds",t,e,a)},n.getSingleMeasures=function(t,e,a){return r("Measures",t,e,a)},n.getSingleDataEntities=function(t,e,a){return r("DataEntities",t,e,a)},n}]);var yuccaUtilsModule=angular.module("yucca.utils",[]);yuccaUtilsModule.factory("$yuccaHelpers",[function(){return{stream:{wsOutputUrl:function(t,e,a){var n="";e&&null!=e&&a&&null!=a?n=a+"_"+e:a&&null!=a?n=a:n+=stream.stream_code;var r="/topic/output."+t+"."+n;return r}},attrs:{num:function(t,e,a,n){var r=t;return(isNaN(t)||null==t||""==t||"undefined"!=typeof e&&null!=e&&e>t||"undefined"!=typeof a&&null!=a&&t>a)&&(r=n),r},safe:function(t,e){var a=t;return"undefined"!=typeof t&&null!=t&&""!=t||(a=e),a}},utils:{mongoDate2millis:function(t){var e=null;if(t){var a=/\/Date\((-?\d+)([+-]\d{4})?.*/.exec(t);void 0==a[2]&&(a[2]=0);var n=parseInt(a[2]);e=new Date(a[1]-6e4*n)}return e},mongoDate2string:function(t){return this.formatDateFromMillis(this.mongoDate2millis(t).getTime())},isEmpty:function(t){return"undefined"==typeof t||null==t},hex2Rgb:function(t){"#"==t.charAt(0)&&(t=t.substring(1,7));var e=parseInt(t.substring(0,2),16),a=parseInt(t.substring(2,4),16),n=parseInt(t.substring(4,6),16);return e+","+a+","+n},formatDateFromMillis:function(t){var e="";if(t){var a=new Date(t),n=a.getDate(),r=a.getMonth()+1,s=a.getFullYear(),l=a.getHours(),o=a.getMinutes();e=""+(9>=n?"0"+n:n)+"/"+(9>=r?"0"+r:r)+"/"+s+" "+(9>=l?"0"+l:l)+":"+(9>=o?"0"+o:o)}return e},lZero:function(t){var e="00";return isNaN(t)||(e=9>=t?"0"+t:t),e},formatData:function(t){var e="";if(t){var a=new Date(t),n=a.getDate(),r=a.getMonth()+1,s=a.getFullYear(),l=a.getHours(),o=a.getMinutes(),i=a.getSeconds();e=""+s+"/"+(9>=r?"0"+r:r)+"/"+(9>=n?"0"+n:n)+" "+(9>=l?"0"+l:l)+":"+(9>=o?"0"+o:o)+":"+(9>=i?"0"+i:i)}return e}},odata:{decodeDateFilter:function(t){console.log("attr",t);var e=null,a=null,n=null,r=null;if(null!=t.timeRange&&""!=t.timeRange){var s=new Date,l=new Date;switch(t.timeRange){case"today":s.setHours(0,0,0,0),l.setHours(23,59,59,999);break;case"yesterday":s.setDate(s.getDate()-1),s.setHours(0,0,0,0),l.setDate(l.getDate()-1),l.setHours(23,59,59,999);break;case"this_month":s=new Date(s.getFullYear(),s.getMonth(),1),l=new Date(s.getFullYear(),s.getMonth()+1,0),l.setHours(23,59,59,999);break;case"last_month":s=new Date(s.getFullYear(),s.getMonth()-1,1),l=new Date(s.getFullYear(),l.getMonth(),0),l.setHours(23,59,59,999);break;case"this_year":s=new Date(s.getFullYear(),0,1),l=new Date(s.getFullYear()+1,0,0),l.setHours(23,59,59,999);break;case"last_year":s=new Date(s.getFullYear()-1,0,1),l=new Date(l.getFullYear(),0,0),l.setHours(23,59,59,999);break;default:s.setHours(0,0,0,0),l.setHours(23,59,59,999)}e=this.formatData(s.getTime()-6e4*s.getTimezoneOffset()),a=this.formatData(l.getTime()-6e4*l.getTimezoneOffset()),n=s.getTime()-6e4*s.getTimezoneOffset(),r=l.getTime()-6e4*l.getTimezoneOffset()}else if(null!=t.timeMaxDate&&""!=t.timeMaxDate&&null!=t.timeMinDate&&""!=t.timeMinDate)n=new Date(t.timeMinDate).getTime(),r=new Date(t.timeMaxDate).getTime(),e=this.formatData(n-6e4*(new Date).getTimezoneOffset()),a=this.formatData(r-6e4*(new Date).getTimezoneOffset());else{var s=new Date,l=new Date;s.setHours(0,0,0,0),l.setHours(23,59,59,999),e=this.formatData(s.getTime()-6e4*s.getTimezoneOffset()),a=this.formatData(l.getTime()-6e4*l.getTimezoneOffset()),n=s.getTime()-6e4*s.getTimezoneOffset(),r=l.getTime()-6e4*l.getTimezoneOffset()}return{timeFilter:"time%20ge%20datetimeoffset%27"+e+"%27%20and%20time%20lt%20datetimeoffset%27"+a+"%27",minDateMillis:n,maxDateMillis:r}},formatData:function(t){var e="";if(t){var a=new Date(t),n=a.getDate(),r=a.getMonth()+1,s=a.getFullYear(),l=a.getHours(),o=a.getMinutes(),i=a.getSeconds(),c="02:00";e=""+s+"-"+(9>=r?"0"+r:r)+"-"+(9>=n?"0"+n:n)+"T"+(9>=l?"0"+l:l)+":"+(9>=o?"0"+o:o)+":"+(9>=i?"0"+i:i),e+="+"+c}return e},extractTimeGroupFilter:function(t,e){var a="year";if(t>0&&e>t){var n=e-t;n<Constants.Time.ONE_DAY?a="hour_dayofmonth_month_year":n<Constants.Time.ONE_MONTH?a="dayofmonth_month_year":n<Constants.Time.ONE_YEAR&&(a="month_year")}return a},timeGroup2resultKey:function(t){var e="year";return"hour_dayofmonth_month_year"==t?e="hour":"dayofmonth_month_year"==t?e="dayofmonth":"month_year"==t&&(e="month"),e},timeGroupLabel:function(t){var e="Year";return"hour_dayofmonth_month_year"==t?e="Hour of the day":"dayofmonth_month_year"==t?e="Day of the month":"month_year"==t&&(e="Month of the year"),e}},statistic:{timeAggregation:function(t){result=[];var e="%H:%M",a=[];if(null!=t&&t.length>1){var n=t[0][0].getTime(),r=t[t.length-1][0].getTime(),s=n-r,l=Constants.Time.ONE_YEAR;s<Constants.Time.ONE_MINUTE?(l=Constants.Time.ONE_MINUTE/6,e="%s s"):s<Constants.Time.ONE_HOUR?(l=Constants.Time.ONE_HOUR/6,e="%m min"):s<Constants.Time.ONE_DAY?(l=Constants.Time.ONE_HOUR/12,e="%H:%M"):s<Constants.Time.ONE_MONTH?(l=Constants.Time.ONE_MONTH/15,e="%d/%M"):s<Constants.Time.ONE_YEAR&&(l=Constants.Time.ONE_YEAR/12,e="%b/%y"),l=s/10;for(var o=r,i=0,c=[],d=t.length-1;d>=0;d--)t[d][0].getTime()<o+l?(c.push(t[d][1]),i++):(result.push({label:o,value:i}),o+=l,a.push(c),i=0,c=[])}return console.debug("in",t),console.debug("out",result),console.debug("dataValues",a),{data:result,labelFormat:e,dataValues:a}}},render:{safeNumber:function(t,e,a){var n=t;return isNaN(t)||(a?n=this.formatEuro(t,e):(isNaN(e)&&(Math.abs(t)>100?e=0:Math.abs(t)<1?(e=-1*Math.log10(t)+1,0>e?e=0:e>20&&(e=20)):e=2),n=parseFloat(t).toFixed(e))),n},completeTweet:function(t,e){var a=t;return a.getTextPretty=this.prettifyTwitterMessage(t.getText),a.createdAtFormatted=e,a.twitterLink="https://twitter.com/"+t.userScreenName+"/status/"+t.tweetid,a.twitterUserLink="https://twitter.com/"+t.userScreenName,a},safeTags:function(t){var e="";if("undefined"!=typeof t&&null!=t){var a=typeof t;e="string"==a?t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"):t}return e},prettifyTwitterUser:function(t){var e="";if("undefined"!=typeof t&&null!=t){var a=typeof t;e="string"==a?t.replace(/(^|\W)(@[a-z\d][\w-]*)/gi,'$1<span class="tweet-user">$2</span>'):t}return e},prettifyTwitterHashtag:function(t){var e="";if("undefined"!=typeof t&&null!=t){var a=typeof t;e="string"==a?t.replace(/(^|\W)(#[a-z\d][\w-]*)/gi,'$1<span class="tweet-hashtag">$2</span>'):t}return e},linkify:function(t){var e="";if("undefined"!=typeof t&&null!=t){var a=typeof t;if("string"==a){var n,r,s;n=/(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim,e=t.replace(n,'<a href="$1" target="_blank">$1</a>'),r=/(^|[^\/])(www\.[\S]+(\b|$))/gim,e=e.replace(r,'$1<a href="http://$2" target="_blank">$2</a>'),s=/(([a-zA-Z0-9\-\_\.])+@[a-zA-Z\_]+?(\.[a-zA-Z]{2,6})+)/gim,e=e.replace(s,'<a href="mailto:$1">$1</a>')}else e=t}return e},prettifyTwitterMessage:function(t){var e=this.safeTags(t);return e=this.linkify(e),e=this.prettifyTwitterHashtag(e),e=this.prettifyTwitterUser(e)},colorLuminance:function(t,e){t=String(t).replace(/[^0-9a-f]/gi,""),t.length<6&&(t=t[0]+t[0]+t[1]+t[1]+t[2]+t[2]),e=e||0;var a,n,r="#";for(n=0;3>n;n++)a=parseInt(t.substr(2*n,2),16),a=Math.round(Math.min(Math.max(0,a+a*e),255)).toString(16),r+=("00"+a).substr(a.length);return r},formatEuro:function(t,e){var a=t;("undefined"==typeof e||isNaN(e))&&(e=2);var n=" €";return isNaN(t)||(a=parseFloat(t).toFixed(e).toString().replace(".",",").replace(/\B(?=(\d{3})+(?!\d))/g,".")),a+n}}}}]);var WebsocketStompSingleton=function(){var t=null,e=[],a=[],n=!1,r=function(){for(var t=0;t<a.length;t++){var n=a[t];debug&&console.debug(":::: Unsubscribe for ::::",n),n.unsubscribe()}e=[],a=[]},s=function(t,l){console.debug("createClient");var o=t,i=Stomp.client(o.ws_url),c=Constants.WEB_SOCKET_USER,d=Constants.WEB_SOCKET_SECRET;return console.debug("intSettings",o),o.user_token&&null!=o.user_token&&""!=o.user_token&&(c="Bearer "+o.user_token,d=""),console.debug("user = ",c),i.connect(c,d,function(t){console.debug("connet 2 - SubscriptionList",e);for(var r=0;r<e.length;r++){var s=e[r];console.debug(":::: subscribe for ::::",s),a.push(i.subscribe(s.keyTopic,s.keyCallback))}console.debug(":::: Finish with the subscribe:::::"),n=!0},function(t){console.info("frame",t),5>l?(console.debug("createClient count ::::::::::::: ",l),setTimeout(function(){s(o,++l)},1e3*l),console.debug("awake.. ")):console.error(":::: connection error::::")}),{getWebClient:function(){return i},addSubscription:function(t,a,r,s){n?(console.debug(":::: addSubscription Client connected::::",t,a),e.push({keyTopic:t,keyCallback:a,keyTenantCode:r,keyDataCallbackIndex:s}),i.subscribe(t,a)):(console.debug(":::: addSubscription Client NOT connected Add to SubscriptionList::::"),e.push({keyTopic:t,keyCallback:a,keyTenantCode:r,keyDataCallbackIndex:s}))},cancelAllSubscriptionsmetadata:r}};return{getInstance:function(e,a){return console.debug("clientInstance",t),t&&null!=t?t:e?(t||(console.debug("::::  New Stomp Client Created ::::"),t=s(e,1)),t):null}}}();yuccaWidgetsModule.directive("bulletChart",function(){return{restrict:"E",scope:{data:"="},template:'<div id="bulletPanel{{panelIndex}}"></div>',link:function(t,e,a){console.log("attr",a),console.log("elem",e),console.log("scope",t),t.panelIndex=Math.floor(1e4*Math.random()+1);var n={top:8,right:8,bottom:8,left:8},n=(d3.format(",.0f"),d3.scale.category20(),{top:5,right:40,bottom:20,left:120});960-n.left-n.right,50-n.top-n.bottom;t.$watch("data",function(){var e=d3.bullet().width(r).height(s);console.log("attr.width in",a.width),console.log("attr.width in",t.data);var r="undefined"==typeof a.width||null==a.width?500:parseInt(a.width),s="undefined"==typeof a.height||null==a.height?500:parseInt(a.height);s=s-n.top-n.bottom,d3.select("#bulletPanel"+t.panelIndex+" svg").remove(),console.log("remove");var l=d3.select("#bulletPanel"+t.panelIndex).selectAll("svg").data(t.data).enter().append("svg").attr("class","bullet-chart").attr("width",r+n.left+n.right).attr("height",s+n.top+n.bottom).append("g").attr("transform","translate("+n.left+","+n.top+")").call(e);console.log("svg",l);var o=l.append("g").style("text-anchor","end").attr("transform","translate(-6,"+s/2+")");o.append("text").attr("class","title").text(function(t){return t.title}),o.append("text").attr("class","subtitle").attr("dy","1em").text(function(t){return t.subtitle}),d3.selectAll("button").on("click",function(){l.datum(randomize).call(e.duration(1e3))})})}}}),d3.bullet=function(){function t(t){t.each(function(t,e){console.log("d",t);var d=r.call(this,t,e).slice().sort(d3.descending),u=s.call(this,t,e).slice().sort(d3.descending),m=l.call(this,t,e).slice().sort(d3.descending),p=d3.select(this),g=d3.scale.linear().domain([0,Math.max(d[0],u[0],m[0])]).range(a?[o,0]:[0,o]),h=this.__chart__||d3.scale.linear().domain([0,1/0]).range(g.range());this.__chart__=g;var f=bulletWidth(h),v=bulletWidth(g),y=p.selectAll("rect.range").data(d);y.enter().append("rect").attr("class",function(t,e){return"range s"+e}).attr("width",f).attr("height",i).attr("x",a?h:0).transition().duration(n).attr("width",v).attr("x",a?g:0),y.transition().duration(n).attr("x",a?g:0).attr("width",v).attr("height",i);var b=p.selectAll("rect.measure").data(m);b.enter().append("rect").attr("class",function(t,e){return"measure s"+e}).attr("width",f).attr("height",i/3).attr("x",a?h:0).attr("y",i/3).transition().duration(n).attr("width",v).attr("x",a?g:0),b.transition().duration(n).attr("width",v).attr("height",i/3).attr("x",a?g:0).attr("y",i/3);var w=p.selectAll("line.marker").data(u);w.enter().append("line").attr("class","marker").attr("x1",h).attr("x2",h).attr("y1",i/6).attr("y2",5*i/6).transition().duration(n).attr("x1",g).attr("x2",g),w.transition().duration(n).attr("x1",g).attr("x2",g).attr("y1",i/6).attr("y2",5*i/6);var k=c||g.tickFormat(8),D=p.selectAll("g.tick").data(g.ticks(8),function(t){return this.textContent||k(t)}),x=D.enter().append("g").attr("class","tick").attr("transform",bulletTranslate(h)).style("opacity",1e-6);x.append("line").attr("y1",i).attr("y2",7*i/6),x.append("text").attr("text-anchor","middle").attr("dy","1em").attr("y",7*i/6).text(k),x.transition().duration(n).attr("transform",bulletTranslate(g)).style("opacity",1);var C=D.transition().duration(n).attr("transform",bulletTranslate(g)).style("opacity",1);C.select("line").attr("y1",i).attr("y2",7*i/6),C.select("text").attr("y",7*i/6),D.exit().transition().duration(n).attr("transform",bulletTranslate(g)).style("opacity",1e-6).remove()}),d3.timer.flush()}var e="left",a=!1,n=0,r=bulletRanges,s=bulletMarkers,l=bulletMeasures,o=380,i=30,c=null;return t.orient=function(n){return arguments.length?(e=n,a="right"==e||"bottom"==e,t):e},t.ranges=function(e){return arguments.length?(r=e,t):r},t.markers=function(e){return arguments.length?(s=e,t):s},t.measures=function(e){return arguments.length?(l=e,t):l},t.width=function(e){return arguments.length?(o=e,t):o},t.height=function(e){return arguments.length?(i=e,t):i},t.tickFormat=function(e){return arguments.length?(c=e,t):c},t.duration=function(e){return arguments.length?(n=e,t):n},t},yuccaWidgetsModule.directive("forcedirectedChart",function(){return{restrict:"E",scope:{links:"="},template:'<div class="forcedirected-chart"><div id="forcedirectedPanel{{panelIndex}}"></div><div class="forcedirected-legend"><div class="forcedirected-legend-block" ng-repeat="block in legendBlocks"><div class="forcedirected-legend-block-title">{{block.label}}</div><span ng-repeat="n in block.items track by $index" class="forcedirected-legend-item legend_{{n.style}}"><span class="forcedirected-legend-bullet"></span><span>{{n.label}}</span></div>',link:function(t,e,a){function n(t,e,a){return"M "+t+" "+e+" m -"+a+", 0 a "+a+","+a+" 0 1,0 "+2*a+",0 a "+a+","+a+" 0 1,0 -"+2*a+",0"}function r(t,e,a){var n=a*Math.sin(Math.PI/3),r=[];r.push({x:t-a,y:e}),r.push({x:t-a/2,y:e+n}),r.push({x:t+a/2,y:e+n}),r.push({x:parseInt(t)+parseInt(a),y:e}),r.push({x:t+a/2,y:e-n}),r.push({x:t-a/2,y:e-n}),r.push({x:t-a,y:e});for(var s="M 0 0",l=0;l<r.length;l++){var o=r[l];s+="L"+o.x+" "+o.y+" "}return s+" Z"}function s(t){return"bezier"==a.linkLine?c(t):"arc"==a.linkLine?l(t):"straight"==a.linkLine?o(t):c(t)}function l(t){var e=t.target.x-t.source.x,a=t.target.y-t.source.y,n=Math.sqrt(e*e+a*a);return"M"+t.source.x+","+t.source.y+"A"+n+","+n+" 0 0,1 "+t.target.x+","+t.target.y}function o(t){return"M"+t.source.x+","+t.source.y+"L"+t.target.x+","+t.target.y}function i(t){return t.replace(/[^\w\s]/gi,"")}function c(t){var e=.5,a=d3.interpolateNumber(t.source.x,t.target.x),n=a(e),r=a(1-e);return"M"+t.source.x+","+t.source.y+"C"+n+","+t.source.y+" "+r+","+t.target.y+" "+t.target.x+","+t.target.y}function d(t){return"translate("+t.x+","+t.y+")"}console.log("forcedirected - link"),t.panelIndex=Math.floor(1e4*Math.random()+1);var u={top:8,right:8,bottom:8,left:8},m=function(t,e){return"hexagon"==t?r(0,0,e):n(0,0,e)},p=t.$eval(a.nodeTypeIcon);"undefined"!=typeof a.linkLine&&null!==a.linkLine||(a.linkLine="bezier");var g=120;"undefined"!=typeof a.linkLength&&null!==a.linkLength&&"null"!==a.linkLength&&""!==a.linkLength&&(g=a.linkLength);var h=10,f=Math.round(h+h/2);"undefined"!=typeof a.nodeSize&&null!==a.nodeSize&&"null"!==a.nodeSize&&""!==a.nodeSize&&(f=a.nodeSize,h=Math.round(2*f/3));var v=!1;"true"==a.computeStatistic&&(v=!0),t.$watch("links",function(){function e(t){w.attr("d",s),k.attr("transform",d),D.attr("transform",d)}var n="undefined"==typeof a.width||null===a.width?500:parseInt(a.width),r="undefined"==typeof a.height||null===a.height?500:parseInt(a.height);r=r-u.top-u.bottom;var l=t.links,o={},c={};t.legendBlocks={Links:{items:[],name:"Links"}},l.forEach(function(e){var a="circle";"undefined"!=typeof p&&null!==p&&"undefined"!=p[e.sourceType]&&(a=p[e.sourceType]),e.source=o[e.source+"_"+e.sourceType]||(o[e.source+"_"+e.sourceType]={name:e.source,type:e.sourceType,label:e.sourceLabel,count:0,radius:f,nodeIcon:a}),o[e.source.name+"_"+e.sourceType].count+=e.count,a="circle","undefined"!=typeof p&&null!==p&&"undefined"!=p[e.sourceType]&&(a=p[e.targetType]),e.target=o[e.target+"_"+e.targetType]||(o[e.target+"_"+e.targetType]={name:e.target,type:e.targetType,label:e.targetLabel,count:0,radius:f,nodeIcon:a}),o[e.target.name+"_"+e.targetType].count+=e.count,"undefined"==typeof c[e.type]&&(c[e.type]=e.type,t.legendBlocks.Links.items.push({label:e.type,style:"Links "+e.type}))}),t.legendNodes=[];for(var h in o)if(o.hasOwnProperty(h)){var v=o[h].type;"undefined"==typeof t.legendBlocks[v]&&(t.legendBlocks[v]={name:v,label:o[h].label,items:[]}),t.legendBlocks[v].items.push({label:o[h].name,style:o[h].type+" "+i(o[h].name.split(" ").join("_"))})}var y=d3.layout.force().nodes(d3.values(o)).links(l).size([n,r]).linkDistance(g).charge(-800).on("tick",e).start();d3.select("#forcedirectedPanel"+t.panelIndex+" svg").remove();var b=d3.select("#forcedirectedPanel"+t.panelIndex).append("svg").attr("class","forcedirected-chart").attr("width",n+u.left+u.right).attr("height",r+u.top+u.bottom),w=b.append("g").selectAll("path").data(y.links()).enter().append("path").attr("class",function(t){return"link link_"+t.type+" source_"+i(t.source.name.split(" ").join("_"))+" target_"+i(t.target.name.split(" ").join("_"))+" link_"+t.sourceType+"_"+t.targetType}).attr("marker-end",function(t){return"url(#link_"+t.sourceType+"_"+t.targetType+")"}),k=b.append("g").selectAll("circle").data(y.nodes()).enter().append("path").attr("d",function(t){return m(t.nodeIcon,t.radius)}).attr("class",function(t){var e="node "+t.type;return"undefined"!=typeof t.name&&(e+=" "+i(t.name.split(" ").join("_"))),e}).call(y.drag),D=b.append("g").selectAll("text").data(y.nodes()).enter().append("text").attr("x",8).attr("y",".31em").attr("class",function(t){var e="label "+t.type;return"undefined"!=typeof t.name&&(e+=" "+i(t.name.split(" ").join("_"))),e}).text(function(t){return t.name})})}}}),yuccaWidgetsModule.directive("forcedirectedChart",function(){return{restrict:"E",scope:{links:"="},template:'<div class="forcedirected-chart"><div id="forcedirectedPanel{{panelIndex}}" class="forcedirected-canvas"></div><div class="forcedirected-legend"><div class="forcedirected-legend-block {{block.name}}" ng-repeat="block in legendBlocks"><div class="forcedirected-legend-block-title">{{block.label}}</div><span ng-repeat="n in block.items track by $index" class="forcedirected-legend-item legend_{{n.style}}"><span class="forcedirected-legend-bullet"></span><span>{{n.label}}</span></div>',link:function(t,e,a){function n(t,e,a){return"M "+t+" "+e+" m -"+a+", 0 a "+a+","+a+" 0 1,0 "+2*a+",0 a "+a+","+a+" 0 1,0 -"+2*a+",0"}function r(t,e,a){var n=a*Math.sin(Math.PI/3),r=new Array;r.push({x:t-a,y:e}),r.push({x:t-a/2,y:e+n}),r.push({x:t+a/2,y:e+n}),r.push({x:parseInt(t)+parseInt(a),y:e}),r.push({x:t+a/2,y:e-n}),r.push({x:t-a/2,y:e-n}),r.push({x:t-a,y:e});for(var s="M 0 0",l=0;l<r.length;l++){var o=r[l];s+="L"+o.x+" "+o.y+" "}return s+" Z"}function s(t){return"bezier"==a.linkLine?c(t):"arc"==a.linkLine?l(t):"straight"==a.linkLine?o(t):c(t)}function l(t){var e=t.target.x-t.source.x,a=t.target.y-t.source.y,n=Math.sqrt(e*e+a*a);return"M"+t.source.x+","+t.source.y+"A"+n+","+n+" 0 0,1 "+t.target.x+","+t.target.y}function o(t){return"M"+t.source.x+","+t.source.y+"L"+t.target.x+","+t.target.y}function i(t){return t.replace(/[^\w\s]/gi,"")}function c(t){var e=.5,a=d3.interpolateNumber(t.source.x,t.target.x),n=a(e),r=a(1-e);return"M"+t.source.x+","+t.source.y+"C"+n+","+t.source.y+" "+r+","+t.target.y+" "+t.target.x+","+t.target.y}function d(t){return"translate("+t.x+","+t.y+")"}t.panelIndex=Math.floor(1e4*Math.random()+1);var u={top:8,right:8,bottom:8,left:8},m=function(t,e){return"hexagon"==t?r(0,0,e):n(0,0,e)},p=t.$eval(a.nodeTypeIcon);console.log("nodeTypeIcon",p),"undefined"!=typeof a.linkLine&&null!==a.linkLine||(a.linkLine="bezier");var g=120;"undefined"!=typeof a.linkLength&&null!==a.linkLength&&"null"!==a.linkLength&&""!==a.linkLength&&(g=a.linkLength);var h=10,f=Math.round(h+h/2);"undefined"!=typeof a.nodeSize&&null!==a.nodeSize&&"null"!==a.nodeSize&&""!==a.nodeSize&&(f=a.nodeSize,h=Math.round(2*f/3)),t.$watch("links",function(){function e(t){w.attr("d",s),k.attr("transform",d),D.attr("transform",d)}var n="undefined"==typeof a.width||null===a.width?500:parseInt(a.width),r="undefined"==typeof a.height||null===a.height?500:parseInt(a.height);r=r-u.top-u.bottom;var l=t.links,o={},c={};t.legendBlocks={Links:{items:[],name:"Links",label:""}},l.forEach(function(e){var a="circle";"undefined"!=typeof p&&null!==p&&"undefined"!=p[e.sourceType]&&(a=p[e.sourceType]),e.source=o[e.source+"_"+e.sourceType]||(o[e.source+"_"+e.sourceType]={name:e.source,type:e.sourceType,label:e.sourceLabel,count:0,radius:f,nodeIcon:a}),o[e.source.name+"_"+e.sourceType].count+=e.count,a="circle","undefined"!=typeof p&&null!==p&&"undefined"!=p[e.sourceType]&&(a=p[e.targetType]),e.target=o[e.target+"_"+e.targetType]||(o[e.target+"_"+e.targetType]={name:e.target,type:e.targetType,label:e.targetLabel,count:0,radius:f,nodeIcon:a}),o[e.target.name+"_"+e.targetType].count+=e.count,"undefined"==typeof c[e.type]&&(c[e.type]=e.type,t.legendBlocks.Links.items.push({label:e.type,style:"Links "+e.type}))}),t.legendNodes=[];for(var h in o)if(o.hasOwnProperty(h)){var v=o[h].type;"undefined"==typeof t.legendBlocks[v]&&(t.legendBlocks[v]={name:v,label:o[h].label,items:[]}),t.legendBlocks[v].items.push({label:o[h].name,style:o[h].type+" "+i(o[h].name.split(" ").join("_"))})}var y=d3.layout.force().nodes(d3.values(o)).links(l).size([n,r]).linkDistance(g).charge(-800).on("tick",e).start();d3.select("#forcedirectedPanel"+t.panelIndex+" svg").remove();var b=d3.select("#forcedirectedPanel"+t.panelIndex).append("svg").attr("class","forcedirected-chart").attr("width",n+u.left+u.right).attr("height",r+u.top+u.bottom),w=b.append("g").selectAll("path").data(y.links()).enter().append("path").attr("class",function(t){return"link link_"+t.type+" source_"+i(t.source.name.split(" ").join("_"))+" target_"+i(t.target.name.split(" ").join("_"))+" link_"+t.sourceType+"_"+t.targetType}).attr("marker-end",function(t){return"url(#link_"+t.sourceType+"_"+t.targetType+")"}),k=b.append("g").selectAll("circle").data(y.nodes()).enter().append("path").attr("d",function(t){return m(t.nodeIcon,t.radius)}).attr("class",function(t){var e="node "+t.type;return"undefined"!=typeof t.name&&(e+=" "+i(t.name.split(" ").join("_"))),e}).call(y.drag),D=b.append("g").selectAll("text").data(y.nodes()).enter().append("text").attr("x",8).attr("y",".31em").attr("class",function(t){var e="label "+t.type;return"undefined"!=typeof t.name&&(e+=" "+i(t.name.split(" ").join("_"))),e}).text(function(t){return t.name})})}}}),yuccaWidgetsModule.directive("sankeyChart",function(){return{restrict:"E",scope:{data:"="},template:'<div id="sankeyPanel{{panelIndex}}"></div><div class="legend" ng-show="legendColors.length>0"><span class="legend-label">0</span><span ng-repeat="c in legendColors track by $index" class="legend-bullet" style="background-color: {{c}}">{{cc}}</span><span class="legend-label">100</span></div>',link:function(t,e,a){function n(t,e){t=String(t).replace(/[^0-9a-f]/gi,""),t.length<6&&(t=t[0]+t[0]+t[1]+t[1]+t[2]+t[2]),e=e||0;var a,n,r="#";for(n=0;3>n;n++)a=parseInt(t.substr(2*n,2),16),a=Math.round(Math.min(Math.max(0,a+a*e),255)).toString(16),r+=("00"+a).substr(a.length);return r}console.log("attr",a),console.log("elem",e),console.log("scope",t),t.panelIndex=Math.floor(1e4*Math.random()+1);var r={top:8,right:8,bottom:8,left:8},s=d3.format(",.0f"),l=function(t){return s(t)},o=d3.scale.category20();t.$watch("data",function(){function e(t){d3.select(this).attr("transform","translate("+t.x+","+(t.y=Math.max(0,Math.min(i-t.dy,d3.event.y)))+")"),d.relayout(),m.attr("d",u)}console.log("attr.width in",a.width);var s="undefined"==typeof a.width||null==a.width?500:parseInt(a.width),i="undefined"==typeof a.height||null==a.height?500:parseInt(a.height);i=i-r.top-r.bottom,d3.select("#sankeyPanel"+t.panelIndex+" svg").remove();var c=d3.select("#sankeyPanel"+t.panelIndex).append("svg").attr("class","sankey-chart").attr("width",s+r.left+r.right).attr("height",i+r.top+r.bottom).append("g").attr("transform","translate("+r.left+","+r.top+")"),d=d3.sankey().nodeWidth(15).nodePadding(10).size([s,i]),u=d.link();d.nodes(t.data.nodes).links(t.data.links).layout(32);var m=c.append("g").selectAll(".link").data(t.data.links).enter().append("path").attr("class","link").attr("d",u).style("stroke-width",function(t){return Math.max(1,t.dy)}).sort(function(t,e){return e.dy-t.dy});m.append("title").text(function(t){return t.source.name+" → "+t.target.name+"\n"+l(t.value)});var p=c.append("g").selectAll(".node").data(t.data.nodes).enter().append("g").attr("class","node").attr("transform",function(t){return"translate("+t.x+","+t.y+")"}).call(d3.behavior.drag().origin(function(t){return t}).on("dragstart",function(){this.parentNode.appendChild(this)}).on("drag",e));p.append("rect").attr("height",function(t){return t.dy}).attr("width",d.nodeWidth()).style("fill",function(t){return"undefined"==typeof t.color||null==t.color?t.color=o(t.name.replace(/ .*/,"")):t.fades&&(t.color=n(t.color,Math.random()-.5)),t.color}).style("stroke",function(t){return d3.rgb(t.color).darker(2)}).append("title").text(function(t){return t.label+"\n"+l(t.value)}),p.append("text").attr("x",-6).attr("y",function(t){return t.dy/2}).attr("dy",".35em").attr("text-anchor","end").attr("transform",null).text(function(t){return t.label}).filter(function(t){return t.x<s/2}).attr("x",6+d.nodeWidth()).attr("text-anchor","start")})}}}),d3.sankey=function(){function t(){p.forEach(function(t){t.sourceLinks=[],t.targetLinks=[]}),g.forEach(function(t){var e=t.source,a=t.target;"number"==typeof e&&(e=t.source=p[t.source]),"number"==typeof a&&(a=t.target=p[t.target]),e.sourceLinks.push(t),a.targetLinks.push(t)})}function e(){p.forEach(function(t){t.value=Math.max(d3.sum(t.sourceLinks,i),d3.sum(t.targetLinks,i))})}function a(){for(var t,e=p,a=0;e.length;)t=[],e.forEach(function(e){e.x=a,e.dx=d,e.sourceLinks.forEach(function(e){t.indexOf(e.target)<0&&t.push(e.target)})}),e=t,++a;n(a),r((m[0]-d)/(a-1))}function n(t){p.forEach(function(e){e.sourceLinks.length||(e.x=t-1)})}function r(t){p.forEach(function(e){e.x*=t})}function s(t){function e(){var t=d3.min(l,function(t){return(m[1]-(t.length-1)*u)/d3.sum(t,i)});l.forEach(function(e){e.forEach(function(e,a){e.y=a,e.dy=e.value*t})}),g.forEach(function(e){e.dy=e.value*t})}function a(t){function e(t){return o(t.source)*t.value}l.forEach(function(a,n){a.forEach(function(a){if(a.targetLinks.length){var n=d3.sum(a.targetLinks,e)/d3.sum(a.targetLinks,i);a.y+=(n-o(a))*t}})})}function n(t){function e(t){return o(t.target)*t.value}l.slice().reverse().forEach(function(a){
a.forEach(function(a){if(a.sourceLinks.length){var n=d3.sum(a.sourceLinks,e)/d3.sum(a.sourceLinks,i);a.y+=(n-o(a))*t}})})}function r(){l.forEach(function(t){var e,a,n,r=0,l=t.length;for(t.sort(s),n=0;l>n;++n)e=t[n],a=r-e.y,a>0&&(e.y+=a),r=e.y+e.dy+u;if(a=r-u-m[1],a>0)for(r=e.y-=a,n=l-2;n>=0;--n)e=t[n],a=e.y+e.dy+u-r,a>0&&(e.y-=a),r=e.y})}function s(t,e){return t.y-e.y}var l=d3.nest().key(function(t){return t.x}).sortKeys(d3.ascending).entries(p).map(function(t){return t.values});e(),r();for(var c=1;t>0;--t)n(c*=.99),r(),a(c),r()}function l(){function t(t,e){return t.source.y-e.source.y}function e(t,e){return t.target.y-e.target.y}p.forEach(function(a){a.sourceLinks.sort(e),a.targetLinks.sort(t)}),p.forEach(function(t){var e=0,a=0;t.sourceLinks.forEach(function(t){t.sy=e,e+=t.dy}),t.targetLinks.forEach(function(t){t.ty=a,a+=t.dy})})}function o(t){return t.y+t.dy/2}function i(t){return t.value}var c={},d=24,u=8,m=[1,1],p=[],g=[];return c.nodeWidth=function(t){return arguments.length?(d=+t,c):d},c.nodePadding=function(t){return arguments.length?(u=+t,c):u},c.nodes=function(t){return arguments.length?(p=t,c):p},c.links=function(t){return arguments.length?(g=t,c):g},c.size=function(t){return arguments.length?(m=t,c):m},c.layout=function(n){return t(),e(),a(),s(n),l(),c},c.relayout=function(){return l(),c},c.link=function(){function t(t){var a=t.source.x+t.source.dx,n=t.target.x,r=d3.interpolateNumber(a,n),s=r(e),l=r(1-e),o=t.source.y+t.sy+t.dy/2,i=t.target.y+t.ty+t.dy/2;return"M"+a+","+o+"C"+s+","+o+" "+l+","+i+" "+n+","+i}var e=.5;return t.curvature=function(a){return arguments.length?(e=+a,t):e},t},c},yuccaWidgetsModule.directive("treemapChart",function(){return{restrict:"E",scope:{data:"=",showLegend:"@"},template:'<div id="treemapPanel{{panelIndex}}"></div><div class="legend" ng-show="legendColors.length>0"><span class="legend-label">0</span><span ng-repeat="c in legendColors track by $index" class="legend-bullet" style="background-color: {{c}}">{{cc}}</span><span class="legend-label">100</span></div>',link:function(t,e,a){function n(t,e){t=String(t).replace(/[^0-9a-f]/gi,""),t.length<6&&(t=t[0]+t[0]+t[1]+t[1]+t[2]+t[2]),e=e||0;var a,n,r="#";for(n=0;3>n;n++)a=parseInt(t.substr(2*n,2),16),a=Math.round(Math.min(Math.max(0,a+a*e),255)).toString(16),r+=("00"+a).substr(a.length);return r}console.debug("Treemap - attr",a),console.debug("Treemap - elem",e),console.debug("Treemap - scope",t);var r=!0;"false"==t.showLegend&&(r=!1),t.panelIndex=Math.floor(1e4*Math.random()+1);var s={top:30,right:0,bottom:0,left:0};t.$watch("data",function(){function e(t){var e=t.name.trim()+" - "+t.value.toFixed();if("undefined"!=typeof t.label&&(e=t.label),t.fourthElement)try{e+=" - "+t.fourthElement.label+": "+parseFloat(t.fourthElement.value).toFixed(1)+"%"}catch(a){}return e}function l(t){var e=t.color?t.color:t.parent.color?t.parent.color:t.parent.parent.color;if(t.fourthElement){var a=.9*t.fourthElement.value/50-.9;e=n(e,a)}return"fill:"+e}function o(t){var e=t.color?t.color:t.parent.color?t.parent.color:t.parent.parent.color;if(t.fourthElement){var a=.9*t.fourthElement.value/50-.9;e=n(e,a)}return"fill: "+i(e)}function i(t){var e=parseInt(t.replace("#",""),16),a=e>>16&255,n=e>>8&255,r=e>>0&255,s=.2126*a+.7152*n+.0722*r,l="#fff";return s>164&&(l="#000"),l}function c(t,e){t.attr("x",function(t){return f(t.x)+6}).attr("y",function(t){return v(t.y)+6}).text(function(t){var e=10,a=t.name.trim().length*e,n=t.name,r=f(t.x+t.dx)-f(t.x);if(a>r){var s=parseInt(r/e)-1;n=s>3?t.name.substring(0,s)+"...":""}return n})}function d(t){t.attr("x",function(t){return f(t.x)}).attr("y",function(t){return v(t.y)}).attr("width",function(t){return f(t.x+t.dx)-f(t.x)}).attr("height",function(t){return v(t.y+t.dy)-v(t.y)})}function u(t){return t.parent?u(t.parent)+"  -  "+t.name:t.name}var m="undefined"==typeof a.width||null==a.width?500:parseInt(a.width),p="undefined"==typeof a.height||null==a.height?500:parseInt(a.height);p=p-s.top-s.bottom;var g=t.data;if(t.legendColors=[],null!=g){var h,f=d3.scale.linear().domain([0,m]).range([0,m]),v=d3.scale.linear().domain([0,p]).range([0,p]),y=d3.layout.treemap().children(function(t,e){return e?null:t._children}).sort(function(t,e){return t.value-e.value}).ratio(p/m*.5*(1+Math.sqrt(5))).round(!1);d3.select("#treemapPanel"+t.panelIndex+" svg").remove();var b=d3.select("#treemapPanel"+t.panelIndex).append("svg").attr("width",m+s.left+s.right).attr("height",p+s.bottom+s.top).style("margin-left",-s.left+"px").style("margin.right",-s.right+"px").append("g").attr("transform","translate("+s.left+","+s.top+")").style("shape-rendering","crispEdges"),w=b.append("g").attr("class","grandparent");w.append("rect").attr("y",-s.top).attr("width",m).attr("height",s.top),w.append("text").attr("x",8).attr("y",8-s.top).attr("dy",".75em");var k=function(t){t.x=t.y=0,t.dx=m,t.dy=p,t.depth=0},D=function(t){return(t._children=t.children)?t.value=t.children.reduce(function(t,e){return t+D(e)},0):t.value},x=function(t){t._children&&(y.nodes({_children:t._children}),t._children.forEach(function(e){e.x=t.x+e.x*t.dx,e.y=t.y+e.y*t.dy,e.dx*=t.dx,e.dy*=t.dy,e.parent=t,x(e)}))},C=function(a){function s(e){if(!h&&e){h=!0;var a=C(e),s=i.transition().duration(750),l=a.transition().duration(750);if(f.domain([e.x,e.x+e.dx]),v.domain([e.y,e.y+e.dy]),b.style("shape-rendering",null),b.selectAll(".depth").sort(function(t,e){return t.depth-e.depth}),a.selectAll("text").style("fill-opacity",0),s.selectAll("text").call(c).style("fill-opacity",0),l.selectAll("text").call(c).style("fill-opacity",1),s.selectAll("rect").call(d),l.selectAll("rect").call(d),s.remove().each("end",function(){b.style("shape-rendering","crispEdges"),h=!1}),"undefined"!=typeof e.parent&&r){t.legendColors=[];for(var o=e.color?e.color:e.parent.color,u=0;5>u;u++){var m=.9*u/2-.9,p=n(o,m);t.legendColors.push(p)}}else t.legendColors=[];t.$apply()}}w.datum(a.parent).on("click",s).select("text").text(u(a));var i=b.insert("g",".grandparent").datum(a).attr("class","depth"),m=i.selectAll("g").data(a._children).enter().append("g");return m.filter(function(t){return t._children}).classed("children",!0).on("click",s),m.selectAll(".child").data(function(t){return t._children||[t]}).enter().append("rect").attr("class","child").attr("style",function(t){return l(t)}).call(d),m.append("rect").attr("class","parent").attr("style",function(t){return l(t)}).call(d).append("title").text(function(t){return e(t)}),m.append("text").attr("dy",".75em").attr("style",function(t){return o(t)}).call(c),m};k(g),D(g),x(g),C(g)}})}}}),yuccaWidgetsModule.directive("ngYuccaDatasetBulletChart",["metadataService","dataService","$yuccaHelpers","$timeout","$compile",function(t,e,a,n,r){"use strict";return{restrict:"E",scope:{},templateUrl:"template/dataset_bullet_chart.html",link:function(t,n,r){console.log("elem",n),t.debug="true"===r.debug,t.debugMessages=[];var s=r.userToken,l=r.filter,o=a.attrs.safe(r.currentValueColumn,null),i=a.attrs.safe(r.previousValueColumn,null),c=t.$eval(r.barColors);"undefined"!=typeof c&&null!=c&&""!=c||(c=Constants.LINE_CHART_COLORS);var d=t.$eval(r.rangeValues,null);null!=d&&3!=d.length&&(t.debugMessages.push("Invalid range values: range values must be an array with 3 elements: Min, Mean, Max"),d=null);var u=t.$eval(r.rangeColumnValues,null);null!=u&&3!=u.length&&(t.debugMessages.push("Invalid range column values: range column values must be an array with 3 elements: Column with Min, Column with Mean, Column with Max"),u=null);var m="true"===r.averageValues,p=(a.attrs.num(r.top,1,1e3,1e3),a.attrs.num(r.top,null,null,1),t.$eval(r.internalIds)),g=a.attrs.safe(r.filterIds,null),h=a.attrs.safe(r.barTitleColumn,null),f=a.attrs.safe(r.barSubtitleColumn,null),v=a.attrs.safe(r.barTitleLabel,null),y=a.attrs.safe(r.barSubtitleLabel,null),b=t.$eval(r.rangeLabels),w=t.$eval(r.measureLabels),k=(t.$eval(r.customMarkers),t.$eval(r.customMarkerColumns)),D=t.$eval(r.markerLabels),x=a.attrs.safe(r.euroValue,!1),C=a.attrs.safe(r.decimalValue,2);t.isEuroValue=function(){return"true"==x},t.chartWidth=a.attrs.num(r.chartWidth,100,null,n[0].offsetWidth),t.chartHeight=a.attrs.num(r.chartHeight,100,null,n[0].offsetHeight);var _=function(e,n,r,s,l){var o=(e.index,"");return o+="  <span class='yucca-dataset-bullet-chart-tooltip'>",o+="    <i class='glyphicon glyphicon-stop' style='color:"+e.color+"'></i> "+e.label+" <strong>"+a.render.safeNumber(e.value,C,t.isEuroValue())+"</strong></span>",o+="  </span>"},M=function(){e.getDataEntities(r.datasetCode,s,l,0,1,null).success(function(t){var a=t.d.__count>1e4?1e4:t.d.__count;e.getMultipleDataEnties(r.datasetCode,s,l,null,a).then(function(t){for(var e=0,a=0,n=null,r=null,s=0;s<t.length;s++)for(var l=0;l<t[s].data.d.results.length;l++){var i=parseFloat(t[s].data.d.results[l][o]);(null==n||n>i)&&(n=i),(null==r||i>r)&&(r=i),e+=i,a++}d.push(n),d.push(e/a),d.push(r),console.log("ranges",d),S()})})};t.options={chart:{type:"bulletChart",duration:500,tooltip:{contentGenerator:_},tickFormat:function(e){return a.render.safeNumber(e,C,t.isEuroValue())},ticks:2}};var T=0,L=function(e,a){console.log("createBulletChart",e);var n=[];null!=u&&(d=[parseFloat(e[u[0]]),parseFloat(e[u[1]]),parseFloat(e[u[2]])]),null!=e[o]&&n.push(parseFloat(e[o].replace(",",".")));var r=v;"undefined"!=typeof h&&null!=h&&""!=h&&(r=e[h]);var s=y;"undefined"!=typeof f&&null!=f&&""!=f&&(s=e[f]);var l="bullet_"+a+"_"+(new Date).getTime(),m={chartId:l,title:r,subtitle:s,ranges:d,measures:n,color:c[T],markers:[],markerLabels:[],markersControl:[]};if(null!=i&&(m.markers.push(e[i]),m.markerLabels.push("Previous")),"undefined"!=typeof k&&null!=k)for(var p=0;p<k.length;p++)m.markersControl.push({marker:k[p],show:!0});if("undefined"!=typeof k&&null!=k)for(var p=0;p<k.length;p++)m.markers.push(e[k[p]]);if("undefined"!=typeof b&&null!=b&&(m.rangeLabels=b),"undefined"!=typeof w&&null!=w&&(m.measureLabels=w),"undefined"!=typeof D&&null!=D)for(var p=0;p<D.length;p++)m.markerLabels.push(D[p]),"undefined"!=typeof m.markersControl[p]&&(m.markersControl[p].label=D[p]);t.chartDataArray.push(m),T++,T==c.length&&(T=0),console.debug("chartData",m),t.isLoading=!1},I=null,S=function(){null!=p?E():e.getDataEntities(r.datasetCode,s,g,0,50,null).success(function(e){if(console.debug("loadIds",e),I=e.d.results,null!=e.d.results&&e.d.__count>0){p=[];for(var a=0;a<e.d.results.length;a++)p.push(e.d.results[a].internalId);E()}else t.infoMessage="No data found",t.isLoading=!1}).error(function(e){t.isLoading=!1,console.error("loadIds error",e),t.debugMessages.push("Load ids error "+e)})},E=function(){t.chartDataArray=[],console.log("loadData",p);if(null!=I&&I.length>0)if(m){for(var a=I[0],n=1;n<I.length;n++)a[o]=parseFloat(a[o])+parseFloat(I[n][o]);a[o]=a[o]/I.length,L(a,0)}else for(var n=0;n<I.length;n++)L(I[n],n);else for(var n=0;n<p.length;n++)e.getSingleDataEntities(r.datasetCode,s,p[n]).then(function(t){L(t.data.d,n)})};t.isLoading=!0,null!=d||null!=u?S():(d=[],M()),console.log("attrs",r),t.widgetTitle=r.widgetTitle,t.widgetIntro=a.attrs.safe(r.widgetIntro,null)}}}]),yuccaWidgetsTemplatesModule.run(["$templateCache",function(t){t.put("template/dataset_bullet_chart.html",'<div class="yucca-widget yucca-dataset-bullet-chart">\n    <header class="yucca-dataset-bullet-chart-header">\n        {{widgetTitle}} {{metadata.stream.smartobject.twtQuery}}\n    </header>\n    <div class="yucca-widget-intro" ng-show="widgetIntro!=null">{{widgetIntro}}</div>\n    <div class="yucca-dataset-bullet-chart-content">\n        <section >\n           <div ng-show="isLoading" class="yucca-dataset-bullet-chart-loading" >\n             <div class="yucca-widget-spinner"><div class="bullet1"></div><div class="bullet2"></div><div class="bullet3"></div></div>\n           </div>\n           <div ng-show="infoMessage!=null" class="yucca-chart-info-message" >\n             <p>{{infoMessage}}</p>\n           </div>\n        	<div ng-show="!isLoading" ng-repeat="chartData in chartDataArray track by $index" class="yucca-dataset-bullet-chart-chart" >\n        		<!--<div class="yucca-dataset-bullet-chart-marker-controls">\n        		  <div class="check-control" ng-repeat="m in chartData.markersControl track by $index">\n        		    <div class="check-bullet" ng-click="toggleMarker(chartData.chartId, m)"></div>{{m.label}}\n        		  </div>\n        		</div>\n				<div id="{{chartData.chartId}}"><nvd3 options="options" data="chartData" ></nvd3></div>-->\n				<nvd3 options="options" data="chartData" ></nvd3>\n				<!--<bullet-chart options="options" data="chartData" width="{{chartWidth}}" height="{{chartHeight}}" ></bullet-chart>-->\n       	</div>\n        </section>\n        <section class="yucca-widget-debug" ng-show="debug && debugMessages.length>0">\n          	<ul><li ng-repeat="m in debugMessages track by $index">{{m}}</li></ul>\n        </section>\n    </div>\n    <footer>\n        <div class="yucca-credits-intro">powered by</div>\n        <a href="http://www.smartdatanet.it/" target="_blank">\n          <i>SmartDataNet.it</i>\n        </a>\n    </footer>\n</div>\n')}]),yuccaWidgetsModule.directive("ngYuccaDatasetChoroplethMap",["metadataService","dataService","$yuccaHelpers","$http","leafletData","$timeout","$compile",function(t,e,a,n,r,s,l){"use strict";return{restrict:"E",scope:{},templateUrl:"template/dataset_choropleth_map.html",link:function(t,s,l){function o(e){var n=e.target;n.setStyle({weight:5,dashArray:"",fillOpacity:.7}),L.Browser.ie||L.Browser.opera||L.Browser.edge||n.bringToFront(),t.info.top=e.layerPoint.y,t.info.left=e.layerPoint.x;var r=a.render.safeNumber(n.feature.properties.value,t.decimalValue,t.isEuroValue());t.info.content="<strong>"+g+"</strong>: "+n.feature.properties[m]+" <br><strong>"+f+"</strong>: "+r,t.info.show=!0}function i(e){var a=e.target;a.setStyle({weight:y,opacity:b,color:w,dashArray:k,fillOpacity:D}),t.info.show=!1}t.debug="true"===l.debug,t.debugMessages=[];var c=l.userToken,d=l.filter,u=(a.attrs.num(l.top,1,1e3,1e3),a.attrs.num(l.top,null,null,1),a.attrs.safe(l.datasetCode,null));null==u&&t.debugMessages.push("Invalid dataset code"),t.datasetChoroplethMapMapId="map"+(new Date).getTime();var m=a.attrs.safe(l.geojsonAreasKey,"name"),p=a.attrs.safe(l.datasetAreasKeyColumn,null),g=a.attrs.safe(l.datasetAreasKeyLabel,p),h=a.attrs.safe(l.datasetAreasValueColumn,null),f=a.attrs.safe(l.datasetAreasValueLabel,h);t.dataKey=p,t.dataValue=h;var v=a.attrs.safe(l.countingMode,"count");null!=p&&null!=h||t.debugMessages.push("Invalid dataset area indicators: specify the column of the key to match with the geojson, and the column for the value in to use");var y=a.attrs.safe(l.mapLineWeight,1),b=a.attrs.safe(l.mapLineOpacity,1),w=a.attrs.safe(l.mapLineDashColor,"#0e232e"),k=a.attrs.safe(l.mapLineDashArray,1),D=a.attrs.safe(l.mapAreasFillOpacity,.7),x=a.attrs.safe(l.areaBaseColor,"#00bbf0"),C=a.attrs.safe(l.geojsonUrl,"lib/yucca-angular-widgets/dist/data/piemonte_province_geojson.json"),_=a.attrs.safe(l.mapTilesUrl,Constants.MAP_TILES_CARTO_DB_POSITRON_URL);t.mapTiles={url:_};var M=a.attrs.safe(l.euroValue,!1);t.decimalValue=a.attrs.safe(l.decimalValue,2),t.isEuroValue=function(){return"true"==M};var T=null,I="true"===l.skipZeroValues,S="false"!==l.showLegend,E=a.attrs.safe(l.legendPosition,"bottomleft"),$="false"!==l.zoomControl,A="false"!==l.scrollWheelZoom;t.defaults={zoomControl:$,scrollWheelZoom:A};var N=null,V=null;t.geojson=null;var W=null;t.tableData=[],t.isLoading=!0,n.get(C).success(function(a){T=a,W=F(T.features),e.getDataEntities(l.datasetCode,c,d,0,1,null).success(function(a){var n=a.d.__count>1e4?1e4:a.d.__count;e.getMultipleDataEnties(l.datasetCode,c,d,null,n).then(function(e){console.debug("choropleth:loadData",e);for(var a=[],n=0,s=0;s<e.length;s++){n=e[s].data.d.__count;for(var l=0;l<e[s].data.d.results.length;l++)a.push(e[s].data.d.results[l])}if(a.length>0){for(var l=0;l<a.length;l++)for(var o=a[l],i=0;i<T.features.length;i++)o[p]==T.features[i].properties[m]&&("undefined"==typeof T.features[i].properties.value&&(T.features[i].properties.value=0),"count"==v?T.features[i].properties.value++:T.features[i].properties.value+=parseFloat(o[h]));for(var c=0;c<T.features.length;c++)t.tableData.push({key:T.features[c].properties[m],value:T.features[c].properties.value}),0!=T.features[c].properties.value&&((null==N||T.features[c].properties.value>N)&&(N=T.features[c].properties.value),(null==V||T.features[c].properties.value<V)&&(V=T.features[c].properties.value));t.geojson={},console.debug("geojson_data",T),t.geojson.data=T,t.geojson.style=H,t.geojson.onEachFeature=P,r.getMap(t.datasetChoroplethMapMapId).then(function(t){t.fitBounds(W)}),S&&U()}t.isLoading=!1},function(e){t.isLoading=!1,console.error("Load data error",e),t.debugMessages.push("Load data error "+e)})}).error(function(e){t.isLoading=!1,console.error("Load data error",e),t.debugMessages.push("Load data error "+e)})}).error(function(e){t.isLoading=!1,console.error("Load geojson error",e),t.debugMessages.push("Load geojson error "+e)});var F=function(t){var e=[];for(var a in t)if("MultiPolygon"==t[a].geometry.type)for(var n in t[a].geometry.coordinates)for(var r in t[a].geometry.coordinates[n]){var s=t[a].geometry.coordinates[n][r];for(var l in s)e.push(L.GeoJSON.coordsToLatLng(s[l]))}else for(var r in t[a].geometry.coordinates){var s=t[a].geometry.coordinates[r];for(var l in s)e.push(L.GeoJSON.coordsToLatLng(s[l]))}return e},H=function(t){return{fillColor:O(t.properties.value),weight:y,opacity:b,color:w,dashArray:k,fillOpacity:D}},O=function(t){if(I&&0==t)return"#ddd";var e=-1*((t-V)/(N-V)-.5)*1.8;return a.render.colorLuminance(x,e)},P=function(t,e){e.on({mouseover:o,mouseout:i})};t.info={show:!1};var U=function(){for(var e=[],n=[],r=(N-V)/6,s=0;5>s;s++){var l=-.9*(s-2);e.push(a.render.colorLuminance(x,l)),0==s?n.push("<"+a.render.safeNumber(r+V,t.decimalValue,t.isEuroValue())):4==s?n.push(">"+a.render.safeNumber(N-r,t.decimalValue,t.isEuroValue())):n.push(""+a.render.safeNumber(V+r*s,t.decimalValue,t.isEuroValue())+" - "+a.render.safeNumber(V+r*(s+1),t.decimalValue,t.isEuroValue()))}t.legend={position:E,colors:e,labels:n}};console.log("attrs",l),t.widgetTitle=l.widgetTitle,t.widgetIntro=a.attrs.safe(l.widgetIntro,null),t.MAP_PIEDMONT_CENTER={lat:45.3522366,lng:7.515388499999972,zoom:7}}}}]),yuccaWidgetsTemplatesModule.run(["$templateCache",function(t){t.put("template/dataset_choropleth_map.html",'<div class="yucca-widget yucca-dataset-choropleth-map">\n    <header class="yucca-dataset-choropleth-map-header">\n        {{widgetTitle}}\n    </header>\n    <div class="yucca-widget-intro" ng-show="widgetIntro!=null">{{widgetIntro}}</div>\n    <div class="yucca-dataset-choropleth-map-content" ng-init="panel=\'map\'">\n      <section class="yucca-dataset-choropleth-map-section" ng-show="panel==\'map\'" >\n           <div ng-show="isLoading" class="yucca-dataset-choropleth-map-loading" >\n             <div class="yucca-widget-spinner"><div class="bullet1"></div><div class="bullet2"></div><div class="bullet3"></div></div>\n           </div>\n           <leaflet ng-attr-id="{{datasetChoroplethMapMapId}}"  defaults="defaults" tiles="mapTiles" bounds="mapBounds" geojson="geojson" class="yucca-dataset-choropleth-map-map" ng-if="geojson!=null" legend="legend" controls="mapControls"></leaflet>\n           <div class="info-panel" ng-show="info.show" style="top:{{info.top}}px; left:{{info.left}}px"><span ng-bind-html="info.content"></span></div>          </section>\n        <section class="yucca-dataset-choropleth-map-data" ng-show="panel==\'data\'">\n           <table class="yucca-dataset-choropleth-map-table">\n               <thead><tr><th>{{dataKey}}</th><th>{{dataValue}}</th></tr>\n               </thead>\n               <tbody ng-repeat="row in tableData track by $index" >\n                   <tr>\n                     <td class="yucca-dataset-choropleth-map-data-key">{{row.key}}</td>\n                     <td class="yucca-dataset-choropleth-map-data-value">{{row.value|safeNumber:decimalValue:isEuroValue()}}</td>\n                   </tr>\n               </tbody>\n           </table>\n        </section>\n        <section class="yucca-widget-debug" ng-show="debug && debugMessages.length>0">\n          	<ul><li ng-repeat="m in debugMessages track by $index">{{m}}</li></ul>\n        </section>\n        <div class="yucca-dataset-choropleth-map-toolbar">\n            <a href ng-click="panel=\'map\'" ng-class="{active: panel == \'chart\'}">Map</a> | <a href ng-click="panel=\'data\'" ng-class="{active: panel == \'data\'}">Data</a> \n        </div>\n    </div>\n    <footer>\n        <div class="yucca-credits-intro">powered by</div>\n        <a href="http://www.smartdatanet.it/" target="_blank">\n          <i>SmartDataNet.it</i>\n        </a>\n    </footer>\n</div>\n')}]),yuccaWidgetsModule.directive("ngYuccaDatasetForceDirectedChart",["metadataService","dataService","$yuccaHelpers",function(t,e,a){"use strict";return{restrict:"AE",scope:{},templateUrl:"template/force_directed_chart.html",link:function(t,n,r){t.debug="true"===r.debug;var s=r.userToken;t.panel=a.attrs.safe(r.landingPanel,"chart");var l=r.filter;t.widgetTitle=a.attrs.safe(r.widgetTitle,"Sankey"),t.widgetIntro=a.attrs.safe(r.widgetIntro,null);a.attrs.safe(r.chartTitle,r.datasetCode);t.chartWidth=a.attrs.num(r.chartWidth,100,null,n[0].offsetWidth),t.chartHeight=a.attrs.num(r.chartHeight,100,null,n[0].offsetHeight);var o=t.$eval(r.nodeColumns),i=t.$eval(r.sankeyNodeRender),c=a.attrs.safe(r.baseColor,null);console.log("sankeyNodeColumns - data",o);var d=t.$eval(r.sankeyNodes),u=t.$eval(r.sankeyLinks),m=a.attrs.safe(r.countingMode,"count"),p=a.attrs.safe(r.valueColumn,null),g=a.attrs.safe(r.euroValue,!1);a.attrs.safe(r.decimalValue,2);t.isEuroValue=function(){return"true"==g},t.sankeyData={nodes:[],links:[]};var h=function(e){console.debug("compactDataForSankey - data",e);for(var a={},n=[],r=[],s=[],l=[],d=0,u=0;u<e.data.length;u++)for(var g=0;g<o.length;g++){if("undefined"==typeof r[o[g]]&&(r[o[g]]=[]),"undefined"==typeof a[o[g]+"_"+e.data[u][o[g]]]){var h={name:""+e.data[u][o[g]],index:d,label:""+e.data[u][o[g]],color:c,fades:!0,group:g};if("undefined"!=typeof i&&"undefined"!=typeof i[o[g]+"_"+h.name]){var f=i[o[g]+"_"+h.name];void 0!=typeof f.label&&(h.label=f.label),void 0!=typeof f.color&&(h.color=f.color),"true"==f.fades?h.fades=!0:h.fades=!1}n.push(h),r[o[g]].push({node:e.data[u][o[g]],index:d}),d++}a[o[g]+"_"+e.data[u][o[g]]]=0}console.debug("sankeyNodes",n),console.debug("sankeyMatrix",r);for(var u=0;u<e.data.length;u++)for(var g=0;g<o.length;g++)if(g<o.length-1)for(var v=o[g],y=0;y<r[v].length;y++)for(var b=r[v][y],w=0;w<r[o[g+1]].length;w++){var k=r[o[g+1]][w];if("undefined"==typeof l[v+"|"+b.node+"|"+k.node]&&(l[v+"|"+b.node+"|"+k.node]={source:b.index,target:k.index,value:0}),e.data[u][o[g]]==b.node&&e.data[u][o[g+1]]==k.node){var D="sum"==m?parseFloat(e.data[u][p]):1;l[v+"|"+b.node+"|"+k.node].value+=D}}console.debug("sankeyLinksDictionary",l);for(var v in l)0!=l[v].value&&s.push(l[v]);t.sankeyData={nodes:n,links:s},console.debug("sankeyData",t.sankeyData)};"undefined"==typeof d||null==d||""==d||"undefined"==typeof u||null==u||""==u?(t.isLoading=!0,e.getDataEntities(r.datasetCode,s,l,0,1,null).success(function(a){var n=a.d.__count>1e4?1e4:a.d.__count;e.getMultipleDataEnties(r.datasetCode,s,l,null,n).then(function(e){for(var a=[],n=0,r=0;r<e.length;r++){n=e[r].data.d.__count;for(var s=0;s<e[r].data.d.results.length;s++)a.push(e[r].data.d.results[s])}h({total:n,data:a}),t.isLoading=!1},function(e){console.log("getMultipleDataEnties error",data),t.isLoading=!1})}).error(function(e){console.log("getDataEntities error",e),t.isLoading=!1})):t.sankeyData={nodes:d,links:u};var f=d3.scale.category20();t.options={chart:{type:"forceDirectedGraph",height:450,width:t.chartWidth,margin:{top:20,right:20,bottom:20,left:20},color:function(t){return f(t.group)},nodeExtras:function(t){t&&t.append("text").attr("dx",8).attr("dy",".35em").text(function(t){return t.name}).style("font-size","10px")}}},console.log("attrs",r)}}}]),yuccaWidgetsTemplatesModule.run(["$templateCache",function(t){t.put("template/force_directed_chart.html",'<div class="yucca-widget yucca-dataset-sankey">\n    <header class="yucca-dataset-sankey-header">\n        {{widgetTitle}} {{metadata.stream.smartobject.twtQuery}}\n    </header>\n    <div class="yucca-widget-intro" ng-show="widgetIntro!=null">{{widgetIntro}}</div>\n    <div class="yucca-dataset-sankey-content">\n        <section class="yucca-dataset-sankey-chart">\n           <div ng-show="isLoading" class="yucca-dataset-sankey-loading" style="min-height: {{chartHeight}}px;min-width: {{chartWidth}}px" ><p>Loading&hellip;</p>\n             <div class="yucca-widget-spinner"> <div class="bullet1"></div><div class="bullet2"></div><div class="bullet3"></div></div>\n           </div>\n           <div ng-show="chartMessage != null" class="yucca-dataset-sankey-chart-message" style="min-height: {{chartHeight}}px;min-width: {{chartWidth}}px">Loading&hellip;</div>\n			<nvd3 ng-show="!isLoading &&  chartMessage == null " options="options" data="sankeyData" class="with-3d-shadow with-transitions"></nvd3>	\n        	<sankey-chart ng-show="!isLoading &&  chartMessage == null "data="sankeyData" width="{{chartWidth}}" height="{{chartHeight}}"></sankey-chart>\n        </section>\n    </div>\n    <footer>\n        <div class="yucca-credits-intro">powered by</div>\n        <a href="http://www.smartdatanet.it/" target="_blank">\n          <i>SmartDataNet.it</i>\n        </a>\n    </footer>\n</div>\n')}]),yuccaWidgetsModule.directive("ngYuccaDatasetForcedirectedChart",["metadataService","dataService","$yuccaHelpers",function(t,e,a){"use strict";return{restrict:"AE",scope:{},templateUrl:"template/forcedirected_chart.html",link:function(t,n,r){t.debug="true"===r.debug;var s=r.userToken;t.panel=a.attrs.safe(r.landingPanel,"chart");var l=r.filter;t.widgetTitle=a.attrs.safe(r.widgetTitle,"Force Directed"),t.widgetIntro=a.attrs.safe(r.widgetIntro,null);a.attrs.safe(r.chartTitle,r.datasetCode);t.chartWidth=a.attrs.num(r.chartWidth,100,null,n[0].offsetWidth),t.chartHeight=a.attrs.num(r.chartHeight,100,null,n[0].offsetHeight);var o=t.$eval(r.nodeColumns),i=t.$eval(r.nodeLabels);"undefined"==typeof i&&(i=o);var c=a.attrs.safe(r.nodeTypeColumn,null);t.$eval(r.forcedirectedNodeRender),a.attrs.safe(r.baseColor,null);t.nodeIcon=a.attrs.safe(r.nodeIcon,null),t.linkLine=a.attrs.safe(r.linkLine,null),t.linkLength=a.attrs.safe(r.linkLength,null),t.nodeSize=a.attrs.safe(r.nodeSize,null),t.nodeTypeIcon=a.attrs.safe(r.nodeTypeIcon,null),console.log("scope.nodeTypeIcon",t.nodeTypeIcon),t.computeStatistic=a.attrs.safe(r.computeStatistic,!1),console.log("forcedirectedNodeColumns - data",o);var d=t.$eval(r.forcedirectedNodes),u=t.$eval(r.forcedirectedLinks);t.forcedirectedLinks=[];var m={},p=function(e){console.log("forcedirectedNodeColumns",o);for(var a=0;a<e.data.length;a++)for(var n=0;n<o.length;n++){var r=null==c?"-":e.data[a][c];g(n,e.data[a],r)}console.log("forcedirectedLinks",m);for(var s in m)m.hasOwnProperty(s)&&t.forcedirectedLinks.push(m[s])},g=function(t,e,a){for(var n=0;n<o.length;n++)if(n!=t){var r=e[o[t]]+"_"+e[o[n]]+"_"+a;"undefined"==typeof m[r]?m[r]={source:e[o[t]],target:e[o[n]],type:a,sourceType:o[t],targetType:o[n],sourceLabel:"undefined"==typeof i[t]?o[t]:i[t],targetLabel:"undefined"==typeof i[n]?o[n]:i[n],count:1}:m[r].count++}};"undefined"==typeof d||null==d||""==d||"undefined"==typeof u||null==u||""==u?(t.isLoading=!0,e.getDataEntities(r.datasetCode,s,l,0,1,null).success(function(a){var n=a.d.__count>1e4?1e4:a.d.__count;e.getMultipleDataEnties(r.datasetCode,s,l,null,n).then(function(e){for(var a=[],n=0,r=0;r<e.length;r++){n=e[r].data.d.__count;for(var s=0;s<e[r].data.d.results.length;s++)a.push(e[r].data.d.results[s])}p({total:n,data:a}),t.isLoading=!1},function(e){console.log("getMultipleDataEnties error",data),t.isLoading=!1})}).error(function(e){console.log("getDataEntities error",e),t.isLoading=!1})):t.forcedirectedData={nodes:d,links:u};d3.scale.category20();console.log("attrs",r)}}}]),yuccaWidgetsTemplatesModule.run(["$templateCache",function(t){t.put("template/forcedirected_chart.html",'<div class="yucca-widget yucca-dataset-forcedirected">\n    <header class="yucca-dataset-forcedirected-header">\n        {{widgetTitle}} {{metadata.stream.smartobject.twtQuery}}\n    </header>\n    <div class="yucca-widget-intro" ng-show="widgetIntro!=null">{{widgetIntro}}</div>\n    <div class="yucca-dataset-forcedirected-content">\n        <section class="yucca-dataset-forcedirected-chart">\n           <div ng-show="isLoading" class="yucca-dataset-forcedirected-loading" style="min-height: {{chartHeight}}px;min-width: {{chartWidth}}px" ><p>Loading&hellip;</p>\n             <div class="yucca-widget-spinner"> <div class="bullet1"></div><div class="bullet2"></div><div class="bullet3"></div></div>\n           </div>\n           <div ng-show="chartMessage != null" class="yucca-dataset-forcedirected-chart-message" style="min-height: {{chartHeight}}px;min-width: {{chartWidth}}px">Loading&hellip;</div>\n        	<forcedirected-chart ng-if="!isLoading &&  chartMessage == null &&  forcedirectedLinks.length>0" links="forcedirectedLinks" link_length={{linkLength}}  node_size={{nodeSize}}                 width="{{chartWidth}}" height="{{chartHeight}}" node_icon="{{nodeIcon}}" link_line="{{linkLine}}" compute_statistic="{{computeStatistic}}" node_type_icon="{{nodeTypeIcon}}"></forcedirected-chart>\n        </section>\n    </div>\n    <footer>\n        <div class="yucca-credits-intro">powered by</div>\n        <a href="http://www.smartdatanet.it/" target="_blank">\n          <i>SmartDataNet.it</i>\n        </a>\n    </footer>\n</div>\n')}]),yuccaWidgetsModule.directive("ngYuccaDatasetImageGallery",["metadataService","dataService","$yuccaHelpers","$interval","leafletData","$compile","$timeout",function(t,e,a,n,r,s,l){"use strict";return{restrict:"E",scope:{},templateUrl:"template/dataset_image_gallery.html",link:function(t,r,o){var i=o.userToken;t.debug="true"===o.debug,t.panel=a.attrs.safe(o.landingPanel,"slideshow"),t.datasetImageGalleryMapId="map"+(new Date).getTime();var c=o.filter,d=o.skip,u=o.top;isNaN(u)||1>u?u=10:u>50&&(u=50);var m=o.interval;(isNaN(m)||500>m)&&(m=2e3);var p=t.$eval(o.imageColumns);t.hasMap=!1;var g=null;void 0!=typeof o.positionColumns&&null!=o.positionColumns&&(g=t.$eval(o.positionColumns),t.hasMap=!0);var h=o.imageTitleColumn,f="true"===o.markerAsImage,v=o.markerUrl;t.showTitle="false"!==o.showTitle;var y=o.markerUrl;"undefined"!=typeof y&&null!=y||(y="#00bbf0"),t.allData=[],t.currentImageIndex=0,t.nexImage=function(e){null!=e&&e<t.allData.length?(t.currentImageIndex=e,n.cancel(b)):t.currentImageIndex>=t.allData.length-1?t.currentImageIndex=0:t.currentImageIndex++};var b=n(function(){t.nexImage()},m);t.mapData={markers:{},markerstyles:[]};var w={};w[t.datasetImageGalleryMapId]=[];var k=function(e,a,n){var r={};return r.lat=parseFloat(a),r.lng=parseFloat(n),f?r.icon={iconUrl:e,iconSize:[48,48]}:null!=v&&""!=v?r.icon={iconUrl:v}:r.icon={markerColor:y},r.message="<img src='"+e+"'  class='yucca-dataset-image-gallery-popup-img'> </img>",w[t.datasetImageGalleryMapId].push([L.latLng(r.lat,r.lng)]),r};t.totalCount="-",t.imgUrl=null,t.debugMessages=[],t.datasetImageGalleryMaxBounds={southWest:{lat:38.700247900602726,lng:-9.165430068969727},northEast:{lat:38.72703673982525,lng:-9.110498428344725}},e.getDataEntities(o.datasetCode,i,c,d,u,"internalId%20desc").success(function(a){if(null!=a&&null!=a.d){t.totalCount=a.d.__count;for(var n=[],r=[],s=[],l=0;l<a.d.results.length;l++){for(var i=a.d.results[l],c=i.Binaries.__deferred.uri.replace("http://","https://"),d=0;d<p.length;d++)null!=i[p[d]]&&(n.push(i[p[d]].idBinary),r[i[p[d]].idBinary]=[i[g[0]],i[g[1]]],"undefined"!=typeof h&&null!=h&&(s[i[p[d]].idBinary]=i[h]));for(var d=0;d<p.length;d++)null!=i[p[d]]?e.getBinariesData(c).success(function(e){console.log("idBinary, binariesData",e);
for(var a=0;a<e.d.results.length;a++){var l=e.d.results[a].idBinary;if(n.indexOf(l)>-1){var o=e.d.results[a].urlDownloadBinary,i=e.d.results[a].aliasNameBinary;console.log("urlDownloadBinary",o);var c={};c.url=Constants.API_DATA_URL+o.substring(5),c.label=i,"undefined"!=typeof s[l]&&null!=s[l]&&""!=s[l]&&(c.label=s[l]),t.allData.push(c),t.hasMap&&null!=r[l]&&(t.mapData.markers[l.replace(".","_")]=k("http:"+c.url,r[l][0],r[l][1])),console.log(t.mapData.markers)}}}):t.debugMessages.push("Invalid column name: "+p[d])}}else t.debugMessages.push("No data found with dataset code "+o.datasetCode)}),t.viewMap=function(){t.panel="map",l(function(){var e='<leaflet width="100%" height="300px" markers="mapData.markers" maxbounds="datasetImageGalleryMaxBounds"></leaflet>';angular.element(document.getElementById(t.datasetImageGalleryMapId)).empty().append(s(e)(t));var a=new L.latLngBounds(w[t.datasetImageGalleryMapId]);t.datasetImageGalleryMaxBounds={southWest:a.getSouthWest(),northEast:a.getNorthEast()},console.info("scope.datasetImageGalleryMaxBounds",t.datasetImageGalleryMaxBounds)},100)},console.log("attrs",o),t.widgetTitle=o.widgetTitle,t.widgetIntro=a.attrs.safe(o.widgetIntro,null)}}}]),yuccaWidgetsTemplatesModule.run(["$templateCache",function(t){t.put("template/dataset_image_gallery.html",'<div class="yucca-widget yucca-dataset-image-gallery">\n    <header class="yucca-dataset-image-gallery-header">\n        {{widgetTitle}}\n    </header>\n    <div class="yucca-widget-intro" ng-show="widgetIntro!=null">{{widgetIntro}}</div>\n    <div class="yucca-dataset-image-gallery-content">\n        <section class="yucca-dataset-image-gallery-map" ng-show="panel==\'map\'">\n             <div ng-attr-id="{{datasetImageGalleryMapId}}"></div>\n        </section>\n        <section class="yucca-dataset-image-gallery-slideshow" ng-show="panel==\'slideshow\'" >\n        	<div>\n              <img ng-src="{{data.url}}" ng-repeat="data in allData track by $index" ng-show="$index==currentImageIndex"/>\n              <div class="yucca-dataset-image-gallery-slide-title" ng-show="showTitle">{{allData[currentImageIndex].label}}</div>\n              <div class="yucca-dataset-image-gallery-bullets-panel">\n                  <a ng-repeat="image in allData track by $index" href ng-click="nexImage($index)" class="yucca-dataset-image-gallery-bullet" ng-class="{active: $index == currentImageIndex}"></a>\n        	   </div>\n        	</div>\n        </section>\n        <section class="yucca-widget-debug" ng-show="debug && debugMessages.length>0">\n          	<ul><li ng-repeat="m in debugMessages track by $index">{{m}}</li></ul>\n        </section>\n        <section class="yucca-dataset-image-gallery-data" ng-hide="allData!=null">\n           No data\n        </section>\n        <section class="yucca-dataset-image-gallery-total-count">\n            Total: {{totalCount}}\n        </section>\n        <section class="yucca-dataset-image-gallery-toolbar" ng-show="hasMap">\n            <a href ng-click="viewMap()"  ng-class="{active: panel == \'map\'}">Map</a> | <a href ng-click="panel=\'slideshow\'"  ng-class="{active: panel == \'slideshow\'}">Slideshow</a> \n        </section>\n    </div>\n    <footer>\n        <div class="yucca-credits-intro">powered by</div>\n        <a href="http://www.smartdatanet.it/" target="_blank">\n          <i>SmartDataNet.it</i>\n        </a>\n    </footer>\n</div>\n')}]),yuccaWidgetsModule.directive("ngYuccaDatasetMultidataStats",["metadataService","dataService","$yuccaHelpers",function(t,e,a){"use strict";return{restrict:"E",scope:{},templateUrl:"template/dataset_multidata_stats.html",link:function(t,n,r){t.debug="true"===r.debug;var s=r.userToken;t.panel=a.attrs.safe(r.landingPanel,"chart");var l=r.filter,o=a.attrs.safe(r.firstGroupColumn,null),i=t.$eval(r.firstGroupColors);"undefined"!=typeof i&&null!=i&&0!=i.length||(i=Constants.LINE_CHART_COLORS);var c=t.$eval(r.secondGroupColumn);console.log("secondGroupColumn",c);var d=t.$eval(r.secondGroupLabel),u=a.attrs.safe(r.thirdGroupColumn,null),m=r.countingMode,p=a.attrs.safe(r.histogramGroupColumn,null),g=a.attrs.safe(r.histogramGroupValueColumn,null);"undefined"==typeof c&&null==p?(c=[o],m="count"):null!=p&&(c=[]);var h=a.attrs.num(r.chartHeight,100,null,400),f=a.attrs.safe(r.chartType,"multiBarChart"),v=a.attrs.safe(r.groupingWay,"grouped"),y=!1;"stacked"==v&&(y=!0);var b=(a.attrs.num(r.top,1,1e3,1e3),a.attrs.num(r.top,null,null,1),function(e,a,n,r,s){var l=(e.index,"");l+="  <h3 class='yucca-dataset-multidata-stats-tooltip-header'>"+e.value+"</h3>",l+="<div class='yucca-dataset-multidata-stats-tooltip'>",l+="  <table><tbody>";for(var o=0;o<t.chartData.length;o++)for(var i=t.chartData[o],c=0;c<i.values.length;c++){var d=i.values[c];if(d.label==e.value){var u="";i.key==e.data.key&&(u="font-weight:  bold; color: "+i.color+";"),l+="  <tr style='"+u+"'>",l+="      <td><span class='yucca-dataset-multidata-stats-tooltip-label'>"+d.key+"</span></td>",l+="      <td><span class='yucca-dataset-multidata-stats-tooltip-value'>"+d.value+"</span></td>",l+="  </tr>"}}return l+="  </tbody></table>",l+="</div>"});t.options={chart:{type:f,height:parseInt(h),margin:{top:24,right:24,bottom:24,left:64},x:function(t){return t.label},y:function(t){return t.value},showValues:!0,valueFormat:function(t){return parseInt(t)},duration:500,stacked:y,xAxis:{showMaxMin:!1},yAxis:{axisLabelDistance:-10},tooltip:{contentGenerator:b}}};var w=[];t.changeTableData=function(e,a){console.log("index",e,a),a&&null!=u&&(t.tableData=w[e])};var k=function(e){var a={},n={},r=0,s={},l={};if(null!=p)for(var h=0;h<e.length;h++){var f=e[h];c.indexOf(f[p])<0&&c.push(f[p])}for(var h=0;h<e.length;h++){var f=e[h];if("undefined"==typeof a[f[o]]){var v=[];l[f[o]]=[f[o]];for(var y=0;y<c.length;y++){n[f[o]+"_"+c[y]]=y;var b=c[y];"undefined"!=typeof d&&null!=d&&d.length>y&&(b=d[y]),v[y]={label:b,value:0},l[f[o]].push(0),s[f[o]]={}}a[f[o]]=[{key:f[o],values:v}],"undefined"!=typeof i&&null!=i&&r<i.length&&(a[f[o]][0].color=i[r],r++)}for(var y=0;y<c.length;y++){var k=1;if(null!=p?c[y]==f[p]?"sum"==m&&null!=g&&(k=parseInt(f[g])):k=0:"sum"==m&&(k=parseInt(f[c[y]])),a[f[o]][0].values[n[f[o]+"_"+c[y]]].value+=k,l[f[o]][y+1]+=k,null!=u){var D=f[u];if("undefined"==typeof s[f[o]][D]){s[f[o]][D]=new Array(c.length),s[f[o]][D][0]=D;for(var x=0;x<c.length;x++)s[f[o]][D][x+1]=0}s[f[o]][D][y+1]+=k}}}console.log("secondGroupColumn",c),console.log("dataGroup",a),console.log("valueIndexs",n);for(var C in a)t.chartData.push(a[C][0]);w.push({title:"",mainPanel:!0,data:l});for(var _ in s)w.push({title:_,mainPanel:!1,data:s[_]});t.tableData=w[0],console.log("scope.chartData",t.chartData),console.log("allTableData  f",w),console.log("detailsTableData  f",s)};t.tableData=[],t.tableDataColums=[];for(var D=0;D<c.length;D++){var x=c[D];"undefined"!=typeof d&&null!=d&&d.length>D&&(x=d[D]),t.tableDataColums.push(x)}t.chartData=[],e.getDataEntities(r.datasetCode,s,l,0,1,null).success(function(a){console.log("firstData",a),e.getMultipleDataEnties(r.datasetCode,s,l,"internalId%20desc",a.d.__count).then(function(e){var a=[];console.log("data",e);for(var n=0;n<e.length;n++)a=a.concat(e[n].data.d.results);console.log("allData",a),k(a),console.log("----",t.allChartData)})}),console.log("attrs",r),t.widgetTitle=r.widgetTitle,t.widgetIntro=a.attrs.safe(r.widgetIntro,null)}}}]),yuccaWidgetsTemplatesModule.run(["$templateCache",function(t){t.put("template/dataset_multidata_stats.html",'<div class="yucca-widget yucca-dataset-multidata-stats">\n    <header class="yucca-dataset-multidata-stats-header">\n        {{widgetTitle}} {{metadata.stream.smartobject.twtQuery}}\n    </header>\n    <div class="yucca-widget-intro" ng-show="widgetIntro!=null">{{widgetIntro}}</div>\n    <div class="yucca-dataset-multidata-stats-content">\n        <section class="yucca-dataset-multidata-stats-chart" ng-show="panel==\'chart\'">\n        	<nvd3 options="options" data="chartData"></nvd3>\n        </section>\n        <section class="yucca-dataset-multidata-stats-data"  ng-show="panel==\'data\'">\n           <table class="yucca-dataset-multidata-stats-table">\n               <thead >\n                  <tr>\n                      <th><a href ng-click="changeTableData(0, true)" ng-hide="tableData.mainPanel"><span  class="back">&laquo; Back</span> </a> {{tableData.title}}</th>\n                      <th ng-repeat="title in tableDataColums track by $index">{{title}}</th>\n                  </tr>\n               </thead>\n               <tbody>\n                   <tr ng-repeat="row in tableData.data track by $index" ng-click="changeTableData(($index+1), tableData.mainPanel)" ng-class="{selectable: tableData.mainPanel}">\n                     <td ng-repeat="data in row track by $index">\n                         <span class="yucca-dataset-multidata-stats-value">{{data}}</span>\n                     </td>\n                   </tr>\n               </tbody>\n           </table>\n        </section>\n        <section class="yucca-dataset-multidata-stats-toolbar">\n            <a href ng-click="panel=\'chart\'" ng-class="{active: panel == \'chart\'}">Chart</a> | <a href ng-click="panel=\'data\'" ng-class="{active: panel == \'data\'}">Data</a> \n        </section>\n    </div>\n    <footer>\n        <div class="yucca-credits-intro">powered by</div>\n        <a href="http://www.smartdatanet.it/" target="_blank">\n          <i>SmartDataNet.it</i>\n        </a>\n    </footer>\n</div>\n')}]),yuccaWidgetsModule.directive("ngYuccaDatasetMultidataTreemap",["metadataService","dataService","$yuccaHelpers",function(t,e,a){"use strict";return{restrict:"AE",scope:{},templateUrl:"template/dataset_multidata_treemap.html",link:function(t,n,r){t.treemapData=null,t.debug="true"===r.debug;var s=r.userToken;t.panel=a.attrs.safe(r.landingPanel,"chart");var l=r.filter;t.widgetTitle=a.attrs.safe(r.widgetTitle,"Treemap"),t.widgetIntro=a.attrs.safe(r.widgetIntro,null);var o=a.attrs.safe(r.chartTitle,r.datasetCode),i=a.attrs.safe(r.secondGroupColumn,null),c=t.$eval(r.colors);"undefined"!=typeof c&&null!=c&&0!=c.length||(c=Constants.LINE_CHART_COLORS);var d=t.$eval(r.firstGroupColumn);console.log("secondGroupColumn",i);var u=t.$eval(r.firstGroupLabel),m=a.attrs.safe(r.thirdGroupColumn,null),p=a.attrs.safe(r.fourthGroupColumn,null),g=a.attrs.safe(r.euroValue,!1);t.decimalValue=a.attrs.safe(r.decimalValue,2),t.isEuroValue=function(){return"true"==g};var h=r.countingMode;t.chartWidth=a.attrs.num(r.chartWidth,100,null,500),t.chartHeight=a.attrs.num(r.chartHeight,100,null,400);var f=(a.attrs.num(r.top,1,1e3,1e3),a.attrs.num(r.top,null,null,1),[]);t.changeTableData=function(e,a){console.log("index",e,a),a&&null!=m&&(t.tableData=f[e])},t.treemapData={name:o,children:[]};var v=function(e){for(var a={},n={},r=[],s=0;s<d.length;s++)r[d[s]]=[];for(var l=1,g=0;g<e.length;g++){var v=e[g];if("undefined"==typeof r[d[0]][v[i]])for(var s=0;s<d.length;s++)r[d[s]][v[i]]=[];"undefined"==typeof a[v[i]]&&(a[v[i]]=[v[i]],n[v[i]]={});for(var s=0;s<d.length;s++){var y=p?v[p]:0;null!=m&&"undefined"==typeof r[d[s]][v[i]][v[m]]&&(r[d[s]][v[i]][v[m]]={value:0,fourthElement:y}),"sum"==h&&(l=parseFloat(v[d[s]])),r[d[s]][v[i]][v[m]].value+=l,a[v[i]].length==s+1&&a[v[i]].push(0),a[v[i]][s+1]+=l;var b=v[m];if("undefined"==typeof n[v[i]][b]){n[v[i]][b]=new Array(d.length),n[v[i]][b][0]=b;for(var w=0;w<d.length;w++)n[v[i]][b][w+1]=0}n[v[i]][b][s+1]+=l}}console.log("mainTableData new",a),console.log("detailsTableData new",n),f.push({title:"",mainPanel:!0,data:a});for(var k in n)f.push({title:k,mainPanel:!1,data:n[k]});t.tableData=f[0],t.treemapData={name:o,children:[]};var D=0;for(var x in r)if(r.hasOwnProperty(x)){var C=x;"undefined"!=typeof u&&null!=u&&"undefined"!=typeof u[D]&&null!=u[D]&&(C=u[D]),D++;var _={name:C,children:[],color:c[D]};for(var M in r[x])if(r[x].hasOwnProperty(M)){var T={name:M,children:[]};for(var L in r[x][M])r[x][M].hasOwnProperty(L)&&T.children.push({name:L,value:r[x][M][L].value,fourthElement:{label:p,value:r[x][M][L].fourthElement}});_.children.push(T)}t.treemapData.children.push(_)}console.log("scope.treemapData",t.treemapData)};t.tableData=[],t.tableDataColums=[];for(var y=0;y<d.length;y++){var b=d[y];"undefined"!=typeof u&&null!=u&&u.length>y&&(b=u[y]),t.tableDataColums.push(b)}t.isLoading=!0,t.chartMessage=null,e.getDataEntities(r.datasetCode,s,l,0,1,null).success(function(a){console.log("firstData",a),e.getMultipleDataEnties(r.datasetCode,s,l,"internalId%20desc",a.d.__count).then(function(e){if(t.isLoading=!1,t.chartMessage=null,"undefined"==typeof e||null==e||0==e.length)t.chartMessage="No data found";else{var a=[];console.log("data",e);for(var n=0;n<e.length;n++)a=a.concat(e[n].data.d.results);console.log("allData",a),v(a),console.log("----",t.allChartData)}},function(){t.isLoading=!1,t.chartMessage="An error occurred. Please try again later."})}),console.log("attrs",r)}}}]),yuccaWidgetsTemplatesModule.run(["$templateCache",function(t){t.put("template/dataset_multidata_treemap.html",'<div class="yucca-widget yucca-dataset-multidata-treemap">\n    <header class="yucca-dataset-multidata-treemap-header">\n        {{widgetTitle}} {{metadata.stream.smartobject.twtQuery}}\n    </header>\n    <div class="yucca-widget-intro" ng-show="widgetIntro!=null">{{widgetIntro}}</div>\n    <div class="yucca-dataset-multidata-treemap-content">\n        <section class="yucca-dataset-multidata-treemap-chart" ng-show="panel==\'chart\'">\n           <div ng-show="isLoading" class="yucca-dataset-multidata-treemap-loading" style="min-height: {{chartHeight}}px;min-width: {{chartWidth}}px" ><p>Loading&hellip;</p>\n             <div class="yucca-widget-spinner"> <div class="bullet1"></div><div class="bullet2"></div><div class="bullet3"></div></div>\n           </div>\n           <div ng-show="chartMessage != null" class="yucca-dataset-multidata-treemap-chart-message" style="min-height: {{chartHeight}}px;min-width: {{chartWidth}}px">Loading&hellip;</div>\n        	<treemap-chart ng-show="!isLoading &&  chartMessage == null "data="treemapData" width="{{chartWidth}}" height="{{chartHeight}}"></treemap-chart>\n        </section>\n        <section class="yucca-dataset-multidata-treemap-data"  ng-show="panel==\'data\'">\n           <table class="yucca-dataset-multidata-treemap-table">\n               <thead >\n                  <tr>\n                      <th><a href ng-click="changeTableData(0, true)" ng-hide="tableData.mainPanel"><span  class="back">&laquo; Back</span> </a> {{tableData.title}}</th>\n                      <th ng-repeat="title in tableDataColums track by $index">{{title}}</th>\n                  </tr>\n               </thead>\n               <tbody>\n                   <tr ng-repeat="row in tableData.data track by $index" ng-click="changeTableData(($index+1), tableData.mainPanel)" ng-class="{selectable: tableData.mainPanel}">\n                     <td ng-repeat="data in row track by $index">\n                         <span class="yucca-dataset-multidata-treemap-value">{{data|safeNumber:decimalValue:isEuroValue()}}</span>\n                     </td>\n                   </tr>\n               </tbody>\n           </table>\n        </section>\n        <section class="yucca-dataset-multidata-treemap-toolbar">\n            <a href ng-click="panel=\'chart\'" ng-class="{active: panel == \'chart\'}">Chart</a> | <a href ng-click="panel=\'data\'" ng-class="{active: panel == \'data\'}">Data</a> \n        </section>\n    </div>\n    <footer>\n        <div class="yucca-credits-intro">powered by</div>\n        <a href="http://www.smartdatanet.it/" target="_blank">\n          <i>SmartDataNet.it</i>\n        </a>\n    </footer>\n</div>\n')}]),yuccaWidgetsModule.directive("ngYuccaDatasetPopulationPyramid",["metadataService","dataService","$yuccaHelpers",function(t,e,a){"use strict";return{restrict:"E",scope:{},templateUrl:"template/dataset_population_pyramid.html",link:function(t,n,r){t.debug="true"===r.debug;var s=r.userToken;t.panel=a.attrs.safe(r.landingPanel,"chart");var l=r.filter,o=a.attrs.safe(r.genderColumn,null),i=t.$eval(r.genderLabels);"undefined"!=typeof i&&null!=i&&0!=i.length||(i=["F","M"]);var c=t.$eval(r.genderValues);"undefined"!=typeof c&&null!=c&&0!=c.length||(c=["F","M"]);var d=t.$eval(r.genderColors);"undefined"!=typeof d&&null!=d&&2==d.length||(d=["#f8a0df","#19aeff"]);var u=a.attrs.safe(r.ageColumn,null),m=a.attrs.safe(r.ageValues,null),m=t.$eval(r.ageValues);"undefined"==typeof m||null==m||0==m.length;var p=t.$eval(r.ageLabels);"undefined"!=typeof p&&null!=p&&0!=p.length||(p=null);var g=a.attrs.safe(r.valueColumn,null),h=a.attrs.safe(r.countingMode,"count"),f=a.attrs.num(r.chartHeight,100,null,400),v=a.attrs.safe(r.chartType,"multiBarHorizontalChart"),y=a.attrs.safe(r.groupingWay,"stacked"),b=!1;"stacked"==y&&(b=!0);var w=(a.attrs.num(r.top,1,1e3,1e3),a.attrs.num(r.top,null,null,1),function(e,a,n,r,s){var l=(e.index,"");l+="  <h3 class='yucca-dataset-population-pyramid-tooltip-header'>"+e.value+"</h3>",l+="<div class='yucca-dataset-population-pyramid-tooltip'>",l+="  <table><tbody>";for(var o=0;o<t.chartData.length;o++)for(var i=t.chartData[o],c=0;c<i.values.length;c++){var d=i.values[c];if(d.label==e.value){var u="";i.key==e.data.key&&(u="font-weight:  bold; color: "+i.color+";"),l+="  <tr style='"+u+"'>",l+="      <td><span class='yucca-dataset-population-pyramid-tooltip-label'>"+d.key+"</span></td>",l+="      <td><span class='yucca-dataset-population-pyramid-tooltip-value'>"+d.valueLabel+"</span></td>",l+="  </tr>"}}return l+="  </tbody></table>",l+="</div>"});t.options={chart:{type:v,height:parseInt(f),margin:{top:24,right:24,bottom:24,left:64},x:function(t){return t.label},y:function(t){return t.value},showValues:!0,valueFormat:function(t){return parseInt(t)},duration:500,stacked:b,xAxis:{showMaxMin:!1},yAxis:{axisLabelDistance:-10,tickFormat:function(t){return Math.abs(t)}},tooltip:{contentGenerator:w}}};var k=function(e){try{t.chartData=[{key:i[0],color:d[0],values:[]},{key:i[1],color:d[1],values:[]}],t.tableData=[];var a={},n={};if(null!=m)for(var r=0;r<m.length;r++)a[m[r]]=0,n[m[r]]=0;for(var r=0;r<e.length;r++){var s=e[r];"undefined"==typeof a[s[u]]&&(a[s[u]]=0,n[s[u]]=0),console.log("d[valueColumn]",s[g]);var l=isNaN(s[g])?0:parseInt(s[g]);s[o]==c[0]?"count"==h?a[s[u]]--:"sum"==h&&(a[s[u]]-=parseInt(l)):s[o]==c[1]&&("count"==h?n[s[u]]++:"sum"==h&&(n[s[u]]+=parseInt(l)))}for(var f in a)if(a.hasOwnProperty(f)){var v=f;null!=p&&"undefined"!=typeof p[f]&&null!=p[f]&&(v=p[f]),t.chartData[0].values.push({label:v,value:a[f],valueLabel:-1*a[f]}),t.chartData[1].values.push({label:v,value:n[f],valueLabel:n[f]}),t.tableData.push([f,-1*a[f],n[f]])}console.log("chartData",t.chartData),console.log("tableData",t.tableData)}catch(y){console.error("groupData",y)}};t.isLoading=!0,e.getDataEntities(r.datasetCode,s,l,0,1,null).success(function(a){console.log("firstData",a),e.getMultipleDataEnties(r.datasetCode,s,l,"internalId%20desc",a.d.__count).then(function(e){var a=[];console.log("data",e);for(var n=0;n<e.length;n++)a=a.concat(e[n].data.d.results);console.log("allData",a),t.isLoading=!1,k(a)})}),console.log("attrs",r),t.widgetTitle=r.widgetTitle,t.widgetIntro=a.attrs.safe(r.widgetIntro,null)}}}]),yuccaWidgetsTemplatesModule.run(["$templateCache",function(t){t.put("template/dataset_population_pyramid.html",'<div class="yucca-widget yucca-dataset-population-pyramid">\n    <header class="yucca-dataset-population-pyramid-header">\n        {{widgetTitle}} {{metadata.stream.smartobject.twtQuery}}\n    </header>\n    <div class="yucca-widget-intro" ng-show="widgetIntro!=null">{{widgetIntro}}</div>\n    <div class="yucca-dataset-population-pyramid-content">\n        <section class="yucca-dataset-population-pyramid-chart" ng-show="panel==\'chart\'">\n           <div ng-show="isLoading" class="yucca-dataset-pyramid-data-loading" style="min-height: {{chartHeight}}px;min-width: {{chartWidth}}px" ><p>Loading&hellip;</p>\n             <div class="yucca-widget-spinner"> <div class="bullet1"></div><div class="bullet2"></div><div class="bullet3"></div></div>\n           </div>\n        	<nvd3 options="options" data="chartData" ></nvd3>\n        </section>\n        <section class="yucca-dataset-population-pyramid-data"  ng-show="panel==\'data\'">\n           <div ng-show="isLoading" class="yucca-dataset-pyramid-data-loading" style="min-height: {{chartHeight}}px;min-width: {{chartWidth}}px" ><p>Loading&hellip;</p>\n             <div class="yucca-widget-spinner"> <div class="bullet1"></div><div class="bullet2"></div><div class="bullet3"></div></div>\n           </div>\n           <table class="yucca-dataset-population-pyramid-table" ng-show="!isLoading" >\n               <thead >\n                  <tr>\n                      <th>{{tableData.title}}</th>\n                      <th>F</th>\n                      <th>M</th>\n                  </tr>\n               </thead>\n               <tbody>\n                   <tr ng-repeat="row in tableData track by $index">\n                     <td ng-repeat="data in row track by $index">\n                         <span>{{data}}</span>\n                     </td>\n                   </tr>\n               </tbody>\n           </table>\n        </section>\n        <section class="yucca-dataset-population-pyramid-toolbar">\n            <a href ng-click="panel=\'chart\'" ng-class="{active: panel == \'chart\'}">Chart</a> | <a href ng-click="panel=\'data\'" ng-class="{active: panel == \'data\'}">Data</a> \n        </section>\n    </div>\n    <footer>\n        <div class="yucca-credits-intro">powered by</div>\n        <a href="http://www.smartdatanet.it/" target="_blank">\n          <i>SmartDataNet.it</i>\n        </a>\n    </footer>\n</div>\n')}]),yuccaWidgetsModule.directive("ngYuccaDatasetSankeyChart",["metadataService","dataService","$yuccaHelpers",function(t,e,a){"use strict";return{restrict:"AE",scope:{},templateUrl:"template/dataset_sankey_chart.html",link:function(t,n,r){t.debug="true"===r.debug;var s=r.userToken;t.panel=a.attrs.safe(r.landingPanel,"chart");var l=r.filter;t.widgetTitle=a.attrs.safe(r.widgetTitle,"Sankey"),t.widgetIntro=a.attrs.safe(r.widgetIntro,null);a.attrs.safe(r.chartTitle,r.datasetCode);t.chartWidth=a.attrs.num(r.chartWidth,100,null,n[0].offsetWidth),t.chartHeight=a.attrs.num(r.chartHeight,100,null,n[0].offsetHeight);var o=t.$eval(r.nodeColumns),i=t.$eval(r.sankeyNodeRender),c=a.attrs.safe(r.baseColor,null);console.log("sankeyNodeColumns - data",o);var d=t.$eval(r.sankeyNodes),u=t.$eval(r.sankeyLinks),m=a.attrs.safe(r.countingMode,"count"),p=a.attrs.safe(r.valueColumn,null),g=a.attrs.safe(r.euroValue,!1);a.attrs.safe(r.decimalValue,2);t.isEuroValue=function(){return"true"==g},t.sankeyData={nodes:[],links:[]};var h=function(e){console.debug("compactDataForSankey - data",e);for(var a={},n=[],r=[],s=[],l=[],d=0,u=0;u<e.data.length;u++)for(var g=0;g<o.length;g++){if("undefined"==typeof r[o[g]]&&(r[o[g]]=[]),"undefined"==typeof a[o[g]+"_"+e.data[u][o[g]]]){var h={name:""+e.data[u][o[g]],index:d,label:""+e.data[u][o[g]],color:c,fades:!0};if("undefined"!=typeof i&&"undefined"!=typeof i[o[g]+"_"+h.name]){var f=i[o[g]+"_"+h.name];void 0!=typeof f.label&&(h.label=f.label),void 0!=typeof f.color&&(h.color=f.color),"true"==f.fades?h.fades=!0:h.fades=!1}n.push(h),r[o[g]].push({node:e.data[u][o[g]],index:d}),d++}a[o[g]+"_"+e.data[u][o[g]]]=0}console.debug("sankeyNodes",n),console.debug("sankeyMatrix",r);for(var u=0;u<e.data.length;u++)for(var g=0;g<o.length;g++)if(g<o.length-1)for(var v=o[g],y=0;y<r[v].length;y++)for(var b=r[v][y],w=0;w<r[o[g+1]].length;w++){var k=r[o[g+1]][w];if("undefined"==typeof l[v+"|"+b.node+"|"+k.node]&&(l[v+"|"+b.node+"|"+k.node]={source:b.index,target:k.index,value:0}),e.data[u][o[g]]==b.node&&e.data[u][o[g+1]]==k.node){var D="sum"==m?parseFloat(e.data[u][p]):1;l[v+"|"+b.node+"|"+k.node].value+=D}}console.debug("sankeyLinksDictionary",l);for(var v in l)0!=l[v].value&&s.push(l[v]);t.sankeyData={nodes:n,links:s},console.debug("sankeyData",t.sankeyData)};"undefined"==typeof d||null==d||""==d||"undefined"==typeof u||null==u||""==u?(t.isLoading=!0,e.getDataEntities(r.datasetCode,s,l,0,1,null).success(function(a){var n=a.d.__count>1e4?1e4:a.d.__count;e.getMultipleDataEnties(r.datasetCode,s,l,null,n).then(function(e){for(var a=[],n=0,r=0;r<e.length;r++){n=e[r].data.d.__count;for(var s=0;s<e[r].data.d.results.length;s++)a.push(e[r].data.d.results[s])}h({total:n,data:a}),t.isLoading=!1},function(e){console.log("getMultipleDataEnties error",data),t.isLoading=!1})}).error(function(e){console.log("getDataEntities error",e),t.isLoading=!1})):t.sankeyData={nodes:d,links:u},console.log("attrs",r)}}}]),yuccaWidgetsTemplatesModule.run(["$templateCache",function(t){t.put("template/dataset_sankey_chart.html",'<div class="yucca-widget yucca-dataset-sankey">\n    <header class="yucca-dataset-sankey-header">\n        {{widgetTitle}} {{metadata.stream.smartobject.twtQuery}}\n    </header>\n    <div class="yucca-widget-intro" ng-show="widgetIntro!=null">{{widgetIntro}}</div>\n    <div class="yucca-dataset-sankey-content">\n        <section class="yucca-dataset-sankey-chart">\n           <div ng-show="isLoading" class="yucca-dataset-sankey-loading" style="min-height: {{chartHeight}}px;min-width: {{chartWidth}}px" ><p>Loading&hellip;</p>\n             <div class="yucca-widget-spinner"> <div class="bullet1"></div><div class="bullet2"></div><div class="bullet3"></div></div>\n           </div>\n           <div ng-show="chartMessage != null" class="yucca-dataset-sankey-chart-message" style="min-height: {{chartHeight}}px;min-width: {{chartWidth}}px">Loading&hellip;</div>\n        	<sankey-chart ng-show="!isLoading &&  chartMessage == null "data="sankeyData" width="{{chartWidth}}" height="{{chartHeight}}"></sankey-chart>\n        </section>\n    </div>\n    <footer>\n        <div class="yucca-credits-intro">powered by</div>\n        <a href="http://www.smartdatanet.it/" target="_blank">\n          <i>SmartDataNet.it</i>\n        </a>\n    </footer>\n</div>\n')}]),yuccaWidgetsModule.directive("ngYuccaDatasetTreemap",["metadataService","dataService","$yuccaHelpers",function(t,e,a){"use strict";return{restrict:"AE",scope:{},templateUrl:"template/dataset_treemap.html",link:function(t,n,r){t.treemapData=null,t.debug="true"===r.debug;var s=r.userToken;t.panel=a.attrs.safe(r.landingPanel,"chart");var l=r.filter;t.widgetTitle=a.attrs.safe(r.widgetTitle,"Treemap"),t.widgetIntro=a.attrs.safe(r.widgetIntro,null);var o=a.attrs.safe(r.chartTitle,r.datasetCode),i=Constants.LINE_CHART_COLORS,c=a.attrs.safe(r.firstLevelColumn,null),d=t.$eval(r.firstLevelRender),u=a.attrs.safe(r.secondLevelColumn,null),m=t.$eval(r.secondLevelRender),p=a.attrs.safe(r.thirdLevelColumn,null),g=t.$eval(r.thirdLevelRender),h=a.attrs.safe(r.valueColumn,null),f=a.attrs.safe(r.euroValue,!1);t.decimalValue=a.attrs.safe(r.decimalValue,2),t.isEuroValue=function(){return"true"==f},console.debug("firstLevelColumn",c),console.debug("firstLevelRender",d),console.debug("secondLevelColumn",u),console.debug("secondLevelRender",m),console.debug("thirdLevelColumn",p),console.debug("thirdLevelRender",g),console.debug("valueColumn",h);var v=a.attrs.safe(r.countingMode,"count");t.chartWidth=a.attrs.num(r.chartWidth,100,null,n[0].offsetWidth),t.chartHeight=a.attrs.num(r.chartHeight,100,null,n[0].offsetHeight);a.attrs.num(r.top,1,1e3,1e3),a.attrs.num(r.top,null,null,1);t.backTableData=function(e){e.level--,t.changeTableData(e)},t.changeTableData=function(e){if(t.tableData.data=[],t.tableData.current=e,0==e.level){t.tableData.level=0,t.tableData.title=o;for(var a in w)w.hasOwnProperty(a)&&t.tableData.data.push({level:1,first:a,name:w[a].name,value:w[a].value})}else if(1==e.level){t.tableData.level=1,t.tableData.title=w[e.first].name;for(var n in w[e.first].children)w[e.first].children.hasOwnProperty(n)&&t.tableData.data.push({level:2,first:e.first,second:n,name:w[e.first].children[n].name,value:w[e.first].children[n].value})}else if(2==e.level){t.tableData.level=2,t.tableData.title=w[e.first].children[e.second].name;for(var r in w[e.first].children[e.second].children)w[e.first].children[e.second].children.hasOwnProperty(r)&&t.tableData.data.push({level:2,first:e.first,second:e.second,name:w[e.first].children[e.second].children[r].name,value:w[e.first].children[e.second].children[r].value})}},t.treemapData={name:o,children:[]};var y=0,b=function(t,e,a,n){var r={name:t[e],value:0,children:{}};return n&&(r.color=i[y],y++,y==i.length&&(y=0)),null!=a&&"undefined"!=typeof a[t[e]]&&("undefined"!=typeof a[t[e]].label&&(r.name=a[t[e]].label),n&&"undefined"!=typeof a[t[c]].color&&(r.color=a[t[e]].color)),r},w={},k=function(e){var n={};if(null!=c){for(var r=0;r<e.length;r++){var s=e[r];"undefined"==typeof w[s[c]]&&(w[s[c]]=b(s,c,d,!0)),w[s[c]].value+="sum"==v?parseFloat(s[h]):1,"undefined"==typeof w[s[c]].children[s[u]]&&(w[s[c]].children[s[u]]=b(s,u,m,!1)),w[s[c]].children[s[u]].value+="sum"==v?parseFloat(s[h]):1,"undefined"==typeof w[s[c]].children[s[u]].children[s[p]]&&(w[s[c]].children[s[u]].children[s[p]]=b(s,p,g,!1)),w[s[c]].children[s[u]].children[s[p]].value+="sum"==v?parseFloat(s[h]):1;var l=s[c]+"_"+s[u];"undefined"==typeof n[l]&&(n[l]={count:0,total:0,min:null,max:null,detail:{}}),"undefined"==typeof n[l].detail[s[p]]&&(n[l].detail[s[p]]={count:0,total:0}),n[l].count++,n[l].detail[s[p]].count++,"sum"==v&&(n[l].total+=parseFloat(s[h]),n[l].detail[s[p]].total+=parseFloat(s[h]))}console.log("tmpChildrens",w),console.log("percentValues",n)}for(var i in n)if(n.hasOwnProperty(i))for(var f in n[i].detail){var y="sum"==v?n[i].detail[f].total:n[i].detail[f].count;(null==n[i].min||y<n[i].min)&&(n[i].min=y),(null==n[i].max||y>n[i].max)&&(n[i].max=y)}console.log("percentValues",n),t.treemapData={name:o,children:[]};for(var k in w)if(w.hasOwnProperty(k)){var D=t.isEuroValue()?a.render.formatEuro(w[k].value,t.decimalValue):w[k].value,x={name:w[k].name,children:[],color:w[k].color,value:w[k].value,label:w[k].name+" - "+D};for(var C in w[k].children)if(w[k].children.hasOwnProperty(C)){var _=t.isEuroValue()?a.render.formatEuro(w[k].children[C].value,t.decimalValue):w[k].children[C].value,M={name:w[k].children[C].name,children:[],value:w[k].children[C].value,label:w[k].children[C].name+" - "+_};for(var T in w[k].children[C].children)if(w[k].children[C].children.hasOwnProperty(T)){var L=w[k].children[C].children[T].value,I=(n[k+"_"+C].min,n[k+"_"+C].max),S="sum"==v?n[k+"_"+C].total:n[k+"_"+C].count,E=(t.isEuroValue()?a.render.formatEuro(L,t.decimalValue):L,100*L/S),$=100*L/I;M.children.push({name:w[k].children[C].children[T].name,value:w[k].children[C].children[T].value,label:w[k].children[C].children[T].name+" - "+L,fourthElement:{label:w[k].children[C].name+": "+parseFloat(E).toFixed(1)+"%",value:$}})}x.children.push(M)}t.treemapData.children.push(x)}t.changeTableData({level:0}),console.log("scope.treemapData",t.treemapData)};t.tableData=[],t.isLoading=!0,t.chartMessage=null,e.getDataEntities(r.datasetCode,s,l,0,1,null).success(function(a){console.log("firstData",a),e.getMultipleDataEnties(r.datasetCode,s,l,"internalId%20desc",a.d.__count).then(function(e){if(t.isLoading=!1,t.chartMessage=null,"undefined"==typeof e||null==e||0==e.length)t.chartMessage="No data found";else{var a=[];console.log("data",e);for(var n=0;n<e.length;n++)a=a.concat(e[n].data.d.results);console.log("allData",a),k(a),console.log("----",t.allChartData)}},function(){t.isLoading=!1,t.chartMessage="An error occurred. Please try again later."})}),console.log("attrs",r)}}}]),yuccaWidgetsTemplatesModule.run(["$templateCache",function(t){t.put("template/dataset_treemap.html",'<div class="yucca-widget yucca-dataset-treemap">\n    <header class="yucca-dataset-treemap-header">\n        {{widgetTitle}} {{metadata.stream.smartobject.twtQuery}}\n    </header>\n    <div class="yucca-widget-intro" ng-show="widgetIntro!=null">{{widgetIntro}}</div>\n    <div class="yucca-dataset-treemap-content">\n        <section class="yucca-dataset-treemap-chart" ng-show="panel==\'chart\'">\n           <div ng-show="isLoading" class="yucca-dataset-treemap-loading" style="min-height: {{chartHeight}}px;min-width: {{chartWidth}}px" ><p>Loading&hellip;</p>\n             <div class="yucca-widget-spinner"> <div class="bullet1"></div><div class="bullet2"></div><div class="bullet3"></div></div>\n           </div>\n           <div ng-show="chartMessage != null" class="yucca-dataset-treemap-chart-message" style="min-height: {{chartHeight}}px;min-width: {{chartWidth}}px">Loading&hellip;</div>\n        	<treemap-chart ng-show="!isLoading &&  chartMessage == null "data="treemapData" show_legend="false" width="{{chartWidth}}" height="{{chartHeight}}"></treemap-chart>\n        </section>\n        <section class="yucca-dataset-treemap-data"  ng-show="panel==\'data\'">\n           <table class="yucca-dataset-treemap-table">\n               <thead >\n                  <tr>\n                      <th colspan="2"><a href ng-click="backTableData(tableData.current)" ng-hide="tableData.level==0"><span  class="back">&laquo; Back</span> </a> {{tableData.title}}</th>\n                  </tr>\n               </thead>\n               <tbody>\n                   <tr ng-repeat="row in tableData.data track by $index" ng-click="changeTableData(row)" class="yucca-dataset-treemap-table-row">\n                     <td>{{row.name}}</td><td><span class="yucca-dataset-treemap-value">{{row.value|safeNumber:decimalValue:isEuroValue()}}</span></td>\n                   </tr>\n               </tbody>\n           </table>\n        </section>\n        <section class="yucca-dataset-treemap-toolbar">\n            <a href ng-click="panel=\'chart\'" ng-class="{active: panel == \'chart\'}">Chart</a> | <a href ng-click="panel=\'data\'" ng-class="{active: panel == \'data\'}">Data</a> \n        </section>\n    </div>\n    <footer>\n        <div class="yucca-credits-intro">powered by</div>\n        <a href="http://www.smartdatanet.it/" target="_blank">\n          <i>SmartDataNet.it</i>\n        </a>\n    </footer>\n</div>\n');
}]),yuccaWidgetsModule.directive("ngYuccaStreamLastValue",["metadataService","dataService","$yuccaHelpers","$interval","$window",function(t,e,a,n,r){"use strict";return{restrict:"E",scope:{},templateUrl:"template/stream_last_value.html",link:function(s,l,o){var i=!0;r.onblur=function(){console.log(">onblur"),i=!1},r.onfocus=function(){console.log(">onfocus"),i=!0},s.debug="true"===o.debug;var c=o.userToken;s.debugMessages=[],s.showLastUpdate="true"===a.attrs.safe(o.showLastUpdate,!1);var d=a.attrs.safe(o.chartType,"lineChart"),u=a.attrs.num(o.chartHeight,null,null,60),m=a.attrs.num(o.chartWidth,null,null,200),p=a.attrs.safe(o.chartColor,"#0050ef");console.log("chartColor",p);var g=s.$eval(o.labels);"undefined"!=typeof g&&null!=g&&0!=g.length||(g=null);var h=s.$eval(o.components);"undefined"!=typeof h&&null!=h&&0!=h.length||(h=null);var f=function(t,e,a,n,r){var s=(t.index,"");return s="lineChart"==d?t.point.tooltip:t.data.tooltip};s.stream={};var v=new Array;s.lastupdate=new Date,s.options={chart:{type:d,width:m,height:u,interpolate:"basis",showXAxis:!1,showYAxis:!1,showLegend:!1,margin:{top:0,right:6,bottom:25,left:6},x:function(t){return t.x},tooltip:{contentGenerator:f},duration:250}};var y=function(t,e){return{x:parseFloat(t.getTime()),y:parseFloat(e),tooltip:"<h3 class='yucca-stream-tweet-stats-tooltip-header'>"+a.utils.formatData(t.getTime())+"</h3><p>Value :<strong>"+e+"</strong></p>"}},b=!1,w=function(t){b=!0;var e=JSON.parse(t.body),a=e.values[0];s.lastupdate=a.time;for(var n=0;n<s.stream.components.length;n++){var r=s.stream.components[n];for(var l in a.components)if(a.components.hasOwnProperty(l)&&l==r.name){s.stream.components[n].lastValue=a.components[l],s.stream.components[n].lastUpdate=a.time,s.stream.components[n].chartData[0].values.push(y(new Date(a.time),a.components[l])),s.stream.components[n].chartData[0].values.length>50&&s.stream.components[n].chartData[0].values.shift();var o=k(s.stream.components[n].chartData[0].values);s.stream.components[n].minXValue=o[0],s.stream.components[n].maxXValue=o[1],s.stream.components[n].delta=D(s.stream.components[n].chartData[0].values)}}},k=function(t){var e=null,a=null;if("undefined"!=typeof t&&null!=t&&t.length>0)for(var n=0;n<t.length;n++)(null==e||e>t[n].x)&&(e=t[n].x),(null==a||a<t[n].x)&&(a=t[n].x);return[e,a]},D=function(t){var e=null;return"undefined"!=typeof t&&null!=t&&(e=t.length>1?parseFloat(t[t.length-1].y)-parseFloat(t[t.length-2].y):0,e=e.toPrecision(2)),e};void 0!=typeof o.tenantCode&&null!=o.tenantCode&&void 0!=typeof o.streamCode&&null!=o.streamCode&&void 0!=typeof o.smartobjectCode&&null!=o.smartobjectCode?t.getStreamMetadata(o.tenantCode,o.streamCode,o.smartobjectCode,c).success(function(t){if(s.stream.name=t.name,null==h)s.stream.components=t.stream.components,v=t.stream.components;else{s.stream.components=[];for(var n=0;n<t.stream.components.length;n++)for(var r=0;r<h.length;r++)if(h[r]==t.stream.components[n].name){s.stream.components.push(t.stream.components[n]),v.push(t.stream.components[n]);break}}for(var n=0;n<s.stream.components.length;n++)if(s.stream.components[n].chartData=[{key:"data",values:[],color:p}],null!=g)try{s.stream.components[n].label=g[n]}catch(l){s.stream.components[n].label=s.stream.components[n].name,console.error("Component's label not valid")}else s.stream.components[n].label=s.stream.components[n].name;"undefined"!=typeof t.dataset&&null!=t.dataset&&"undefined"!=typeof t.dataset.code&&null!=t.dataset.code&&e.getMeasures(t.dataset.code,c,null,0,20,"time%20desc").success(function(n){return function(r){if(console.debug("getMeasures",n,r),null!=r.d.results&&r.d.results.length>0){r.d.results.reverse();for(var l=0;l<s.stream.components.length;l++){var o=s.stream.components[l];v[l].chartDataValues=new Array;for(var i=0;i<r.d.results.length;i++)null!=r.d.results[i][o.name]&&(0==i&&(s.stream.components[l].lastValue=r.d.results[i][o.name],s.stream.components[l].lastUpdate=a.utils.mongoDate2string(r.d.results[i].time)),v[l].chartDataValues.push(y(a.utils.mongoDate2millis(r.d.results[i].time),r.d.results[i][o.name])));var d=k(v[l].chartDataValues);s.stream.components[l].minXValue=d[0],s.stream.components[l].maxXValue=d[1],s.stream.components[l].delta=D(v[l].chartDataValues)}e.getLastValue(t.tenantCode,t.stream.code,t.stream.smartobject.code,c,w,t.code),b=!0}}}(t.code)),e.getLastValue(t.tenantCode,t.stream.code,t.stream.smartobject.code,c,w,t.code)}).error(function(t){console.log("error",t),s.debugMessages.push("Stream not found: "+s.stream)}):s.debugMessages.push("Invalid stream definition: tenantCode: "+o.tenantCode+" - streamCode: "+o.streamCode+" - smartobjectCode: "+o.smartobjectCode),console.debug("attrs",o),s.widgetTitle=a.attrs.safe(o.widgetTitle,null),s.widgetIntro=a.attrs.safe(o.widgetIntro,null),n(function(){if(b&&i){b=!1;for(var t=0;t<v.length;t++)"undefined"!=typeof v[t].chartDataValues&&(s.stream.components[t].chartData[0].values=v[t].chartDataValues.slice())}},1e3)}}}]),yuccaWidgetsTemplatesModule.run(["$templateCache",function(t){t.put("template/stream_last_value.html",'<div class="yucca-widget yucca-stream-last-value">\n    <header class="yucca-stream-last-value-header" ng-show="widgetTitle!=null"> \n        {{widgetTitle}}\n    </header>\n    <div class="yucca-widget-intro" ng-show="widgetIntro!=null">{{widgetIntro}}</div>\n    <div class="yucca-stream-last-value-content">\n        <section class="yucca-stream-last-value-data">\n           <div class="yucca-stream-last-value-panel " ng-repeat-start="component in stream.components track by $index"> \n               <div class="yucca-stream-last-value-component-name"><span title="Phenomenon: {{component.phenomenon}}">{{component.label}}</span></div>\n               <div class="yucca-stream-last-value-component-panel"> \n                   <div class="yucca-stream-last-value-component-value" title="Exact value: {{component.lastValue}} - Updated at: {{component.lastUpdate|date:\'dd/MM/yyyy  H:mm\'}}">{{component.lastValue|format_big_number}}</div>\n                   <div class="yucca-stream-last-value-component-value-info"> \n                       <div class="yucca-stream-last-value-component-trend" ng-show="component.delta!=null" title="Value trend">\n					        <span class="trend-up" ng-show="component.delta>0">&plus;</span>\n					        <span class="trend-down" ng-show="component.delta<0"></span>\n					        <span class="trend-stable" ng-show="component.delta==0"></span>\n					        {{component.delta}}\n                       </div>\n                       <div class="yucca-stream-last-component-measureunit">{{component.measureunit}}</span> </div>\n                   </div>\n               </div>\n               <div class="yucca-stream-last-value-component-chart" ng-show="component.chartData[0].values.length>1"><nvd3 options="options" data="component.chartData"></nvd3></div>\n               <div class="yucca-stream-last-value-component-chart-x-xAxis" ng-show="component.chartData[0].values.length>1">\n                   <div class="min-value"><span class="value-hour">{{component.minXValue|date:"H:mm"}}</span><span class="value-date">{{component.minXValue|date:"dd MMM yyyy"}}</span></div>\n                   <div class="max-value"><span class="value-hour">{{component.maxXValue|date:"H:mm"}}</span><span class="value-date">{{component.maxXValue|date:"dd MMM yyyy"}}</span></div>\n               </div>\n           </div>\n           <div class="yucca-stream-last-value-panel-separator " ng-repeat-end ng-hide="$index<stream.components.length"></div>\n        </section>\n        <section class="yucca-stream-last-value-lastupdate-bar" ng-show="showLastUpdate">\n            Updated at: {{lastupdate|date:"dd/MM/yyyy  H:mm"}}\n        </section>\n    </div>\n    <footer>\n        <a href="http://www.smartdatanet.it/" target="_blank" title="Powered by smartdatanet.it">\n          <i>SmartDataNet.it</i>\n        </a>\n    </footer>\n</div>\n')}]),yuccaWidgetsModule.directive("ngYuccaStreamMonitor",["metadataService","dataService","$yuccaHelpers","$interval","$window",function(t,e,a,n,r){"use strict";return{restrict:"E",scope:{},templateUrl:"template/stream_monitor.html",link:function(s,l,o){var i=!0;r.onblur=function(){console.log(">onblur"),i=!1},r.onfocus=function(){console.log(">onfocus"),i=!0};var c=o.filter;s.debug="true"===o.debug;var d=o.userToken;s.panel=a.attrs.safe(o.landingPanel,"chart"),s.debugMessages=[],s.showLastUpdate="true"===a.attrs.safe(o.showLastUpdate,!1);var u=a.attrs.safe(o.chartType,"lineChart"),m=a.attrs.num(o.chartHeight,null,null,300),p=a.attrs.num(o.chartWidth,null,null,400),g=s.$eval(o.chartColors);"undefined"!=typeof g&&null!=g&&0!=g.length||(g=Constants.LINE_CHART_COLORS);var h=s.$eval(o.labels);"undefined"!=typeof h&&null!=h&&0!=h.length||(h=null);var h=s.$eval(o.labels);"undefined"!=typeof h&&null!=h&&0!=h.length||(h=null);var f=s.$eval(o.components);"undefined"!=typeof f&&null!=f&&0!=f.length||(f=null),s.stream={},s.lastupdate=new Date,s.options={chart:{type:u,width:p,height:m,useInteractiveGuideline:!0,margin:{top:2,right:2,bottom:2,left:2},x:function(t){return t.x},xAxis:{tickFormat:function(t){return a.utils.formatDateFromMillis(t)}},duration:250}},s.stream.tableDataValues=[],s.stream.chartData=[];var v=new Array,y=function(t,e){var a={x:parseFloat(t.getTime()),y:parseFloat(e)};return a},b=!1,w=function(t){b=!0;var e=JSON.parse(t.body),n=e.values[0];s.lastupdate=n.time,s.stream.tableDataValues.push([a.utils.formatDateFromMillis(new Date(n.time))]);for(var r=0;r<s.stream.components.length;r++){var l=s.stream.components[r];for(var o in n.components)if(n.components.hasOwnProperty(o)&&o==l.name){s.stream.components[r].lastValue=n.components[o],s.stream.components[r].lastUpdate=n.time;for(var i=0;i<v.length;i++)if(v[i].name==l.name){v[i].values.push(y(new Date(n.time),n.components[o])),v[i].values.length>200&&v[i].values.shift();var c=k(v[i].values);s.stream.components[r].minXValue=c[0],s.stream.components[r].maxXValue=c[1];break}s.stream.tableDataValues[s.stream.tableDataValues.length-1].push(n.components[o])}}s.stream.tableDataValues.length>20&&s.stream.tableDataValues.shift()},k=function(t){var e=null,a=null;if("undefined"!=typeof t&&null!=t&&t.length>0)for(var n=0;n<t.length;n++)(null==e||e>t[n].x)&&(e=t[n].x),(null==a||a<t[n].x)&&(a=t[n].x);return[e,a]};void 0!=typeof o.tenantCode&&null!=o.tenantCode&&void 0!=typeof o.streamCode&&null!=o.streamCode&&void 0!=typeof o.smartobjectCode&&null!=o.smartobjectCode?t.getStreamMetadata(o.tenantCode,o.streamCode,o.smartobjectCode,d).success(function(t){console.log("metadata",t),s.stream.name=t.name;var n=0;if(null==f)s.stream.components=t.stream.components;else{s.stream.components=[];for(var r=0;r<t.stream.components.length;r++)for(var l=0;l<f.length;l++)if(f[l]==t.stream.components[r].name){s.stream.components.push(t.stream.components[r]);break}}for(var r=0;r<s.stream.components.length;r++)if(null!=h&&r<h.length)try{s.stream.components[r].label=h[r]}catch(o){s.stream.components[r].label=s.stream.components[r].name,console.error("Component's label not valid")}else s.stream.components[r].label=s.stream.components[r].name;for(var i=0;i<s.stream.components.length;i++){var u=s.stream.components[i];n<g.length?n++:n=0,v.push({name:u.name,key:u.label,values:[],color:g[n]}),s.stream.chartData.push({name:u.name,key:u.label,values:[],color:g[n]})}"undefined"!=typeof t.dataset&&null!=t.dataset&&"undefined"!=typeof t.dataset.code&&null!=t.dataset.code&&e.getMeasures(t.dataset.code,d,c,0,20,"time%20desc").success(function(n){return function(r){if(console.debug("getMeasures",n,r),null!=r.d.results&&r.d.results.length>0){r.d.results.reverse(),s.stream.tableDataValues=[];for(var l=0;l<r.d.results.length;l++){s.stream.tableDataValues[l]=[a.utils.mongoDate2string(r.d.results[l].time)];for(var o=0;o<s.stream.components.length;o++)"undefined"!=typeof r.d.results[l][s.stream.components[o].name]&&null!=r.d.results[l][s.stream.components[o].name]?s.stream.tableDataValues[l].push(r.d.results[l][s.stream.components[o].name]):s.stream.tableDataValues[l].push("-")}for(var o=0;o<s.stream.components.length;o++){var i=s.stream.components[o];v[o].values=[];for(var l=0;l<r.d.results.length;l++)null!=r.d.results[l][i.name]&&(0==l&&(s.stream.components[o].lastValue=r.d.results[l][i.name],s.stream.components[o].lastUpdate=a.utils.mongoDate2string(r.d.results[l].time)),v[o].values.push(y(a.utils.mongoDate2millis(r.d.results[l].time),r.d.results[l][i.name])));var c=k(v[o].values);s.stream.components[o].minXValue=c[0],s.stream.components[o].maxXValue=c[1]}console.log("..",s.stream),b=!0,e.getLastValue(t.tenantCode,t.stream.code,t.stream.smartobject.code,d,w,t.code)}}}(t.code)),e.getLastValue(t.tenantCode,t.stream.code,t.stream.smartobject.code,d,w,t.code)}).error(function(t){console.log("error",t),s.debugMessages.push("Stream not found: "+s.stream)}):s.debugMessages.push("Invalid stream definition: tenantCode: "+o.tenantCode+" - streamCode: "+o.streamCode+" - smartobjectCode: "+o.smartobjectCode),console.debug("attrs",o),s.widgetTitle=a.attrs.safe(o.widgetTitle,null),s.widgetIntro=a.attrs.safe(o.widgetIntro,null),n(function(){if(b&&i){b=!1;for(var t=0;t<v.length;t++)s.stream.chartData[t].values=v[t].values.slice()}},1e3)}}}]),yuccaWidgetsTemplatesModule.run(["$templateCache",function(t){t.put("template/stream_monitor.html",'<div class="yucca-widget yucca-stream-monitor">\n    <header class="yucca-stream-monitor-header" ng-show="widgetTitle!=null"> \n        {{widgetTitle}}\n    </header>\n    <div class="yucca-widget-intro" ng-show="widgetIntro!=null">{{widgetIntro}}</div>\n    <div class="yucca-stream-monitor-content">\n        <section class="yucca-stream-monitor-chart"  ng-show="panel==\'chart\'">\n            <nvd3 options="options" data="stream.chartData"></nvd3>\n            <div class="yucca-stream-monitor-chart-x-xAxis" ng-show="stream.chartData.length>0">\n            	<div class="min-value"><span class="value-hour">{{stream.components[0].minXValue|date:"H:mm"}}</span><span class="value-date">{{stream.components[0].minXValue|date:"dd MMM yyyy"}}</span></div>\n               <div class="max-value"><span class="value-hour">{{stream.components[0].maxXValue|date:"H:mm"}}</span><span class="value-date">{{stream.components[0].maxXValue|date:"dd MMM yyyy"}}</span></div>\n            </div>\n        </section>\n        <section class="yucca-stream-monitor-data" ng-show="panel==\'data\'">\n           <table class="yucca-stream-monitor-data-table">\n               <thead>\n                   <tr><th>Time</th><th ng-repeat="component in stream.components track by $index">{{component.label}}</th></tr>\n               </thead>\n               <tbody>\n                   <tr ng-repeat="row in stream.tableDataValues track by $index">\n                     <td ng-repeat="data in row track by $index">\n                         <span class="yucca-stream-monitor-data-table">{{data}}</span> \n                     </td>\n                   </tr>\n               </tbody>\n           </table>\n        </section>\n        <section class="yucca-stream-monitor-lastupdate-bar" ng-show="showLastUpdate">\n            Updated at: {{lastupdate|date:"dd/MM/yyyy  H:mm"}}\n        </section>\n        <section class="yucca-stream-monitor-toolbar">\n            <a href ng-click="panel=\'chart\'" ng-class="{active: panel == \'chart\'}">Chart</a> | <a href ng-click="panel=\'data\'" ng-class="{active: panel == \'data\'}">Data</a> \n        </section>\n    </div>\n    <footer>\n        <div class="yucca-credits-intro">powered by</div>\n        <a href="http://www.smartdatanet.it/" target="_blank">\n          <i>SmartDataNet.it</i>\n        </a>\n    </footer>\n</div>\n')}]),yuccaWidgetsModule.directive("ngYuccaStreamMultistreamMap",["metadataService","dataService","$yuccaHelpers",function(t,e,a){"use strict";return{restrict:"E",scope:{},templateUrl:"template/stream_multistream_map.html",link:function(e,n,r){e.debug="true"===r.debug;var s=r.userToken;e.panel=a.attrs.safe(r.landingPanel,"map"),e.debugMessages=[];var l=e.$eval(r.streams);e.streams={};var o=r.tenantCode,i=r.domain,c=r.searchQuery,d=null;console.log("attr.opendata",r.opendata),"undefined"!=typeof r.opendata&&(d="true"===r.opendata),void 0!=typeof l&&null!=l&&l.length>0||t.findMetadata(o,i,c,d,s).success(function(t){console.log("metadataList",t)}).error(function(){e.debugMessages.push("No data found: tenant="+o+", domain="+i+", search_query="+c+", opendata="+d)}),console.debug("attrs",r),e.widgetTitle=r.widgetTitle,e.widgetIntro=a.attrs.safe(r.widgetIntro,null)}}}]),yuccaWidgetsTemplatesModule.run(["$templateCache",function(t){t.put("template/stream_multistream_map.html",'<div class="yucca-widget yucca-stream-multistream-map">\n    <header class="yucca-stream-multistream-map-header">\n        {{widgetTitle}}\n    </header>\n    <div class="yucca-widget-intro" ng-show="widgetIntro!=null">{{widgetIntro}}</div>\n    <div class="yucca-stream-multistream-map-content">\n        <section class="yucca-stream-multistream-map-data">\n           <table class="yucca-stream-multistream-map-table">\n               <tbody ng-repeat="stream in streams track by $index" >\n                   <tr>\n                     <td class="yucca-stream-multistream-map-stream-row" colspan="100%">\n                         <span class="yucca-stream-multistream-map-component">{{stream.name}}</span>\n                     </td>\n                   </tr>\n                   <tr ng-repeat="component in stream.components track by $index">\n                     <td class="yucca-stream-multistream-map-component-name"><span title="Phenomenon: {{component.phenomenon}}">{{component.name}}</span></td>\n                     <td class="yucca-stream-multistream-map-component-bullet"><span class="yucca-stream-multistream-map-bullet bullet-{{component.bulletLevel}}" title="{{component.bulletsLevel}}"></span></td>\n                     <td class="yucca-stream-multistream-map-component-value" title="Updated at: {{component.lastUpdate|date:\'MM/dd/yyyy  H:mm\'}}"><span>{{component.lastValue}}</span> <span class="yucca-stream-multistream-component-measureunit">{{component.measureunit}}</span> </td>\n                   </tr>\n               </tbody>\n           </table>\n        </section>\n        <section class="yucca-stream-multistream-map-lastupdate-bar">\n            Updated at: {{lastupdate|date:"MM/dd/yyyy  H:mm"}}\n        </section>\n    </div>\n    <footer>\n        <div class="yucca-credits-intro">powered by</div>\n        <a href="http://www.smartdatanet.it/" target="_blank">\n          <i>SmartDataNet.it</i>\n        </a>\n    </footer>\n</div>\n')}]),yuccaWidgetsModule.directive("ngYuccaStreamMultistreamStats",["metadataService","dataService","$yuccaHelpers","leafletData",function(t,e,a,n){"use strict";return{restrict:"E",scope:{},templateUrl:"template/stream_multistream_stats.html",link:function(r,s,l){r.xAxisTickFormatFunction=function(){return function(t){return d3.time.format("%H:%M:%S")(new Date(t))}},r.panel=a.attrs.safe(l.landingPanel,"map");var o=function(t){return parseInt(t)},i=function(t){return t.hour},c=null,d=null,u=40,m=80;r.mapId="map"+(new Date).getTime();var p=function(){for(var t in r.allData)if(r.allData[t].hasOwnProperty("tableData")){var e=r.allData[t].tableData[1];(null==c||c>e)&&(c=e),(null==d||e>d)&&(d=e)}console.log("min max",c,d)};r.refreshMarker=function(){console.log("scope.allData",r.allData),r.mapData.markerstyles=[];var t=r.allData[r.currentTimeStats];if(console.log("allData",r.allData),!a.utils.isEmpty(t)){console.log("dataAtTime",t);for(var e=0;e<r.allData.datasetsCode.length;e++){var n=parseFloat(t.tableData[e+1]).toFixed(1);n="NaN"===n?0:n,console.log("data",n);var s=(n-c)/(d-c),l=parseInt(u+(m-u)*s),o=r.allData.datasetsCode[e];r.mapData.markerstyles.push(".marker"+o+"{font-size: "+l/2.2+"px; line-height:"+l+"px; border-color:"+b(n,1)+"; background-color:"+b(n,.5)+";}");var i={type:"div",iconSize:[l,l],className:"marker marker"+o,popupAnchor:[0,0],html:n};r.mapData.markers["m_"+o].icon=i}}};var g=a.attrs.num(l.chartHeight,100,null,300),h=a.attrs.safe(l.chartType,"lineChart"),f=(r.$eval(l.chartColors),function(t,e,a,n,r){console.log("key",t);var s=(t.index,"");return s="lineChart"==h?t.point.tooltip:t.data.tooltip});r.options={chart:{type:h,height:g,margin:{top:24,right:24,bottom:24,left:36},interpolate:"basis",x:function(t){return t.x},y:function(t){return t.y},showValues:!0,showLegend:!1,valueFormat:o,duration:500,showXAxis:!0,xAxis:{axisLabel:"Time"+a.odata.timeGroup2resultKey(x)},yAxis:{axisLabel:"",axisLabelDistance:-10},tooltip:{contentGenerator:f}}},r.maxStats=23,r.allData={},r.mapData={markers:{},markerstyles:[]};var v=[];r.currentTimeStats=5;r.allData.tableHeader=["Time"],r.allData.datasetsCode=[];var y=["#009100","#9ade00","#edd400","#f57900","#cc0000"],b=function(t,e){var n=y[2];if(d-c!=0){var r=(t-c)/(d-c),s=parseInt(r*y.length);s>=y.length&&(s=y.length-1),n=y[s]}return"undefined"==typeof n&&(n=y[2]),"rgba("+a.utils.hex2Rgb(n)+","+e+")"},w=function(t,e){r.allData.datasetsCode.push(t.code),r.allData.tableHeader.push(t.code);for(var s=0;s<e.data.length;s++){var l=e.data[s],o=i(e.data[s]);r.allData[o]&&null!=r.allData[o]||(r.allData[o]={},r.allData[o].tableData=[],r.allData[o].tableData.push(l.hour)),r.allData[o].tableData.push(l.value_sts)}if(!a.utils.isEmpty(t.stream)&&!a.utils.isEmpty(t.stream.smartobject.latitude)){var c={lat:parseFloat(t.stream.smartobject.latitude),lng:parseFloat(t.stream.smartobject.longitude),message:t.code},d={type:"div",className:"marker marker"+t.code,popupAnchor:[0,0],html:"-"};c.icon=d,r.mapData.markers["m_"+t.code]=c,r.mapData.markerstyles.push(".marker"+t.code+"{border-radius: 100%;width:30px; height:30px;border:solid 2px red}"),v.push([c.lat,c.lng]),n.getMap().then(function(t){t.invalidateSize(),t.fitBounds(v,{padding:[32,32]})})}},k=a.odata.decodeDateFilter(l),D=k.timeFilter,x=a.attrs.safe(l.timeGroupBy,a.odata.extractTimeGroupFilter(k.minDateMillis,k.maxDateMillis)),C=r.$eval(l.datasets);if(C&&null!=C&&C.length>0)for(var _=0;_<C.length;_++){var M=C[_][0],T=C[_][1];t.getDatasetMetadata(M,T).success(function(t){var a=t,n=Object.keys(t).length;n>0&&a&&null!=a&&e.getMeasuresStats(a.dataset.code,user_token,x,"avg,value",D,null,null,"year,month,dayofmonth,hour").success(function(t){console.log("response",t);var e={key:a.code,metadata:a,data:t.d.results};w(a,e),p(),r.refreshMarker()}).error(function(t){console.error("getDatasetMetadata: error",t)})})}console.log("attrs",l),r.widgetTitle=l.widgetTitle,r.widgetIntro=a.attrs.safe(l.widgetIntro,null)}}}]),yuccaWidgetsTemplatesModule.run(["$templateCache",function(t){t.put("template/stream_multistream_stats.html",'<div class="yucca-widget yucca-stream-multistream-stats">\n    <header class="yucca-stream-multistream-stats-header">\n        {{widgetTitle}}\n    </header>\n    <div class="yucca-widget-intro" ng-show="widgetIntro!=null">{{widgetIntro}}</div>\n    <div class="yucca-stream-multistream-stats-content">\n        <section class="yucca-stream-multistream-stats-map" ng-show="panel==\'map\'">\n           <style>.marker{border-radius: 100%;border:solid 4px;background-color: white; text-align: center;padding-top: -8px;}</style>\n           <style ng-repeat="style in mapData.markerstyles track by $index">{{style}}</style>\n           <leaflet id="{{mapId}}" width="100%" height="300px" markers="mapData.markers"></leaflet>\n           <div class="range-panel"><div class="range-min">0</div><div class="range-container">\n                <div class="range-value">{{currentTimeStats}} h</div>\n                <input type="range" name="points" min="0" max="{{maxStats}}"                     ng-model="currentTimeStats" ng-change="refreshMarker()" class="range-input"></div>\n               <div class="range-max">{{maxStats}}</div>\n           </div> \n        </section>\n        <section class="yucca-stream-multistream-stats-data" ng-show="panel==\'data\'" >\n           <table class="yucca-stream-multistream-stats-table">\n               <thead>\n                   <tr><th ng-repeat="titles in allData.tableHeader track by $index">{{titles}}</th></tr>\n               </thead>\n               <tbody>\n                   <tr ng-repeat="(key, value) in allData track by $index">\n                     <td ng-repeat="data in value.tableData track by $index">{{data}}</td>\n                   </tr>\n               </tbody>\n           </table>\n           <div class="yucca-stream-multistream-stats-component" ng-repeat="(key, value) in lastMessage.values[0].components">               <div class="yucca-stream-multistream-stats-component-key">{{key}}</div>\n               <div class="yucca-stream-multistream-stats-component-value">{{value}}</div>\n               <div class="yucca-stream-multistream-stats-component-measure-unit">{{componentsMap[key].measureUnit}}</div>\n           </div>\n        </section>\n        <section class="yucca-stream-multistream-stats-data" ng-hide="allData!=null">\n           No data\n        </section>\n        <section class="yucca-stream-multistream-stats-total-count">\n            Total: {{totalCount}}\n        </section>\n        <section class="yucca-stream-multistream-stats-toolbar">\n            <a href ng-click="panel=\'map\'" ng-class="{active: panel == \'map\'}">Map</a> | <a href ng-click="panel=\'data\'" ng-class="{active: panel == \'data\'}">Data</a> \n        </section>\n    </div>\n    <footer>\n        <div class="credits-intro">powered by</div>\n        <a href="http://www.smartdataplatform.it/" target="_blank">\n          <i>SmartDataNet.it</i>\n        </a>\n    </footer>\n</div>\n')}]),yuccaWidgetsModule.directive("ngYuccaStreamMultistreamValue",["metadataService","dataService","$yuccaHelpers",function(t,e,a){"use strict";return{restrict:"E",scope:{},templateUrl:"template/stream_multistream_value.html",link:function(n,r,s){n.debug="true"===s.debug;var l=s.userToken;n.debugMessages=[];var o=n.$eval(s.streams);n.streams={},n.lastupdate=new Date;var i=function(t){var e="",a=parseFloat(t.lastValue);if(null!=a){var e="ok";("-"!=t.minWarning&&a<t.minWarning||"-"!=t.maxWarning&&a>t.maxWarning)&&(e="warning"),("-"!=t.minCritical&&a<t.minCritical||"-"!=t.maxCritical&&a>t.maxCritical)&&(e="critical")}return e},c=function(t,e){var a=JSON.parse(t.body);void 0!=typeof e&&null!=e||(e=t.headers.destination.replace("/topic/output.",""));var r=a.values[0];n.lastupdate=r.time;for(var s=0;s<n.streams[e].components.length;s++){var l=n.streams[e].components[s];for(var o in r.components)r.components.hasOwnProperty(o)&&o==l.name&&(n.streams[e].components[s].lastValue=r.components[o],n.streams[e].components[s].bulletLevel=i(n.streams[e].components[s]))}};if(void 0!=typeof o&&null!=o&&o.length>0)for(var d=0;d<o.length;d++){var u=o[d];t.getStreamMetadata(u.tenantCode,u.streamCode,u.smartobjectCode,l).success(function(t){var r={};r.name=t.name,r.components=[];for(var s=0;s<o.length;s++)if(o[s].tenantCode==t.tenantCode&&o[s].streamCode==t.stream.code&&o[s].smartobjectCode==t.stream.smartobject.code)for(var d=0;d<o[s].components.length;d++)for(var u=0;u<t.stream.components.length;u++)if(t.stream.components[u].name==o[s].components[d].name){var m={};m.name=t.stream.components[u].name,m.phenomenon=t.stream.components[u].phenomenon,m.measureunit=t.stream.components[u].measureunit,m.label=a.attrs.safe(o[s].components[d].label,m.name),m.minWarning=a.attrs.safe(o[s].components[d].minWarning,"-"),m.minCritical=a.attrs.safe(o[s].components[d].minCritical,"-"),m.maxWarning=a.attrs.safe(o[s].components[d].maxWarning,"-"),m.maxCritical=a.attrs.safe(o[s].components[d].maxCritical,"-"),m.bulletsLevel="Min Critical: "+m.minCritical+" \r Min Warning: "+m.minWarning+" \rMax Warning: "+m.maxWarning+" \rMax Critical: "+m.maxCritical,r.components.push(m)}n.streams[t.code]=r,"undefined"!=typeof t.dataset&&null!=t.dataset&&"undefined"!=typeof t.dataset.code&&null!=t.dataset.code?(console.debug("load past data"),e.getMeasures(t.dataset.code,l,null,0,1,"time%20desc").success(function(r){return function(s){if(console.debug("getMeasures",r,s),null!=s.d.results&&s.d.results.length>0){for(var o=0;o<n.streams[r].components.length;o++){var d=n.streams[r].components[o];null!=s.d.results[0][d.name]&&(n.streams[r].components[o].lastValue=s.d.results[0][d.name],n.streams[r].components[o].lastUpdate=a.utils.mongoDate2string(s.d.results[0].time),n.streams[r].components[o].bulletLevel=i(n.streams[r].components[o]))}e.getLastValue(t.tenantCode,t.stream.code,t.stream.smartobject.code,l,c,t.code)}}}(t.code))):e.getLastValue(t.tenantCode,t.stream.code,t.stream.smartobject.code,l,c,t.code)}).error(function(){n.debugMessages.push("Stream not found: "+u)})}else n.debugMessages.push("Invalid streams definition: "+o+" - streams must be an array like this [{'tenantCode':'...', 'streamCode':'...', 'smartobjectCode':'...', components: [{component:'',min:'',max:''}], ...");console.debug("attrs",s),n.widgetTitle=s.widgetTitle,n.widgetIntro=a.attrs.safe(s.widgetIntro,null)}}}]),yuccaWidgetsTemplatesModule.run(["$templateCache",function(t){t.put("template/stream_multistream_value.html",'<div class="yucca-widget yucca-stream-multistream-value">\n    <header class="yucca-stream-multistream-value-header">\n        {{widgetTitle}}\n    </header>\n    <div class="yucca-widget-intro" ng-show="widgetIntro!=null">{{widgetIntro}}</div>\n    <div class="yucca-stream-multistream-value-content">\n        <section class="yucca-stream-multistream-value-data">\n           <table class="yucca-stream-multistream-value-table">\n               <tbody ng-repeat="stream in streams track by $index" >\n                   <tr>\n                     <td class="yucca-stream-multistream-value-stream-row" colspan="100%">\n                         <span class="yucca-stream-multistream-value-component">{{stream.name}}</span>\n                     </td>\n                   </tr>\n                   <tr ng-repeat="component in stream.components track by $index">\n                     <td class="yucca-stream-multistream-value-component-name"><span title="Phenomenon: {{component.phenomenon}}">{{component.label}}</span></td>\n                     <td class="yucca-stream-multistream-value-component-bullet"><span class="yucca-stream-multistream-value-bullet bullet-{{component.bulletLevel}}" title="{{component.bulletsLevel}}"></span></td>\n                     <td class="yucca-stream-multistream-value-component-value" title="Updated at: {{component.lastUpdate|date:\'MM/dd/yyyy  H:mm\'}}"><span>{{component.lastValue}}</span> <span class="yucca-stream-multistream-component-measureunit">{{component.measureunit}}</span> </td>\n                   </tr>\n               </tbody>\n           </table>\n        </section>\n        <section class="yucca-stream-multistream-value-lastupdate-bar">\n            Updated at: {{lastupdate|date:"MM/dd/yyyy  H:mm"}}\n        </section>\n    </div>\n    <footer>\n        <div class="yucca-credits-intro">powered by</div>\n        <a href="http://www.smartdatanet.it/" target="_blank">\n          <i>SmartDataNet.it</i>\n        </a>\n    </footer>\n</div>\n')}]),yuccaWidgetsModule.directive("ngYuccaStreamTweetStats",["metadataService","dataService","$yuccaHelpers",function(t,e,a){"use strict";return{restrict:"E",scope:{},templateUrl:"template/stream_tweet_stats.html",link:function(n,r,s){var l=a.attrs.num(s.chartHeight,100,null,300),o=a.attrs.safe(s.chartType,"lineChart"),i=n.$eval(s.chartColors);n.panel=a.attrs.safe(s.landingPanel,"chart"),"undefined"!=typeof i&&null!=i&&0!=i.length||(i=Constants.LINE_CHART_COLORS);var c=function(t){return parseInt(t)},d=function(t,e,a,n,r){console.log("key",t);var s=(t.index,"");return s="lineChart"==o?t.point.tooltip:t.data.tooltip};n.options={chart:{type:o,height:l,margin:{top:24,right:24,bottom:24,left:36},interpolate:"basis",x:function(t){return t.x},y:function(t){return t.y},showValues:!0,showLegend:!1,valueFormat:c,
duration:500,showXAxis:!0,xAxis:{axisLabel:"Time"+a.odata.timeGroup2resultKey(g)},yAxis:{axisLabel:"",axisLabelDistance:-10},tooltip:{contentGenerator:d}}};var u=s.userToken,m=a.odata.decodeDateFilter(s),p=m.timeFilter,g=a.attrs.safe(s.timeGroupBy,a.odata.extractTimeGroupFilter(m.minDateMillis,m.maxDateMillis));n.xAxisLabel=a.odata.timeGroupLabel(g),n.statisticData=[],n.chartData=[],n.statisticData.push({label:"Tweets",value:"-"}),n.statisticData.push({label:"Unique Author",value:"-"}),n.statisticData.push({label:"Tweet/Hour",value:"-"}),n.statisticData.push({label:"Tweet/Author",value:"-"});var h=function(){n.statisticData[0].value>0&&n.statisticData[1].value>0?n.statisticData[3].value=(parseInt(n.statisticData[0].value)/parseInt(n.statisticData[1].value)).toFixed(2):n.statisticData[3].value="-"};n.lastTweets=[],n.mostRetweeted=[],t.getStreamMetadata(s.tenantCode,s.streamCode,s.smartobjectCode).success(function(t){console.log("metadata",t),n.metadata=t,null!=t.dataset.code&&(e.getSocialFeeds(t.dataset.code,u,p,null,10,"time desc").success(function(t){console.log("data",t);for(var e=0;e<t.d.results.length;e++)n.lastTweets.push(a.render.completeTweet(t.d.results[e],a.utils.mongoDate2string(t.d.results[e].createdAt)));n.statisticData[0].value=t.d.__count,h()}),e.getSocialFeeds(t.dataset.code,u,p,null,10,"retweetCount desc").success(function(t){console.log("data",t);for(var e=0;e<t.d.results.length;e++)n.mostRetweeted.push(a.render.completeTweet(t.d.results[e],a.utils.mongoDate2string(t.d.results[e].createdAt)))}),e.getSocialFeedsStats(t.dataset.code,u,g,"sum,tweetid",p,null,null,"year,month,dayofmonth,hour").success(function(t){console.log("statisticData",t);for(var e=[],r=0,s=0;s<t.d.results.length;s++){var l=t.d.results[s],o=a.odata.timeGroup2resultKey(g),c="<h3 class='yucca-stream-tweet-stats-tooltip-header'>";c+=a.utils.lZero(l.dayofmonth)+"/"+a.utils.lZero(l.month)+"/"+l.year,c+="</h3>",c+="<p>Tweet :<strong>"+l.count+"</strong></p>";var d={x:parseFloat(l[o]),y:parseFloat(l.count),tooltip:c};r<i.length&&(d.color=i[r],r++),e.push(d)}e.sort(function(t,e){return t.x-e.x}),n.chartData.push({key:"tweetData",values:e})}),e.getSocialFeedsStats(t.dataset.code,u,"iduser","first,tweetid",p,null,1,null).success(function(t){console.log("statisticData author",t),n.statisticData[1].value=t.d.__count,h()}),e.getSocialFeedsStats(t.dataset.code,u,"hour","sum,tweetid",p,null,1e3,null).success(function(t){if(console.log("statisticData tweet/hour",t),parseInt(t.d.__count)>0){for(var e=0,a=0;a<t.d.results.length;a++)e+=parseInt(t.d.results[a].count);n.statisticData[2].value=(e/t.d.__count).toFixed(2)}}))}),console.log("attrs",s),n.widgetTitle=s.widgetTitle,n.widgetIntro=a.attrs.safe(s.widgetIntro,null)}}}]),yuccaWidgetsTemplatesModule.run(["$templateCache",function(t){t.put("template/stream_tweet_stats.html",'<div class="yucca-widget yucca-stream-tweet-stats">\n    <header class="yucca-stream-tweet-stats-header">\n        {{widgetTitle}} {{metadata.stream.smartobject.twtQuery}}\n    </header>\n    <div class="yucca-widget-intro" ng-show="widgetIntro!=null">{{widgetIntro}}</div>\n    <div class="yucca-stream-tweet-stats-content">\n        <section class="yucca-stream-tweet-stats-chart" ng-show="panel==\'chart\'"">\n            <nvd3 options="options" data="chartData"></nvd3>\n            <div class="yucca-stream-tweet-stats-xaxis-label">{{xAxisLabel}}</div>        </section>\n        <section class="yucca-stream-tweet-stats-data"  ng-show="panel==\'chart\'">\n           <h4>Statistics</h4>\n           <table class="yucca-stream-tweet-stats-table">\n               <tbody>\n                   <tr >\n                     <td ng-repeat="data in statisticData track by $index">\n                         <span class="yucca-stream-tweet-stats-value">{{data.value}}</span><span class="yucca-stream-tweet-stats-label"> {{data.label}}</span>\n                     </td>\n                   </tr>\n               </tbody>\n           </table>\n        </section>\n        <section class="yucca-stream-tweet-stats-last-tweet" ng-show="panel==\'lastTweet\'" >\n           <h4>Last tweets</h4>\n           <div class="yucca-stream-tweet-stats-last-tweet-content">\n           	<div ng-repeat="tweet in lastTweets track by $index" class="yucca-stream-tweet-stats-tweet">\n           		<div class="tweet-message">\n           			<div class="tweet-profile-image"><a href="{{tweet.twitterUserLink}}" target="_blank" title="View user on twitter">\n							<img src="https://twitter.com/{{tweet.userScreenName}}/profile_image?size=normal" />\n						</a></div>\n           			<div class="tweet-author"><a href="{{tweet.twitterUserLink}}" target="_blank" title="View user on twitter">{{tweet.userScreenName}}</a>\n                           <a href="{{tweet.twitterLink}}" target="_blank" title="View on twitter" class="tweet-twitter-link"></a>\n                       </div>\n           			<div class="tweet-text" ng-bind-html="tweet.getTextPretty"></div>\n           		</div>\n           		<div class="tweet-info">\n		           		<div class="tweet-statistic-icons">\n           				<span class="tweet-retweet-icon">{{tweet.retweetCount}}</span>\n           				<span  class="tweet-favorite-icon">{{tweet.favoriteCount}}</span>\n           			</div>\n           			<div class="tweet-date">{{tweet.createdAtFormatted}}</div>\n           		</div>\n               </div>\n           </div>\n        </section>\n        <section class="yucca-stream-tweet-stats-most-retweet" ng-show="panel==\'mostRetweet\'" >\n           <h4>Most retweeted</h4>\n           <div class="yucca-stream-tweet-stats-most-retweet-content">\n           	<div ng-repeat="tweet in mostRetweeted track by $index" class="yucca-stream-tweet-stats-tweet">\n           		<div class="tweet-message">\n           			<div class="tweet-profile-image"><a href="{{tweet.twitterUserLink}}" target="_blank" title="View user on twitter">\n							<img src="https://twitter.com/{{tweet.userScreenName}}/profile_image?size=normal" />\n						</a></div>\n           			<div class="tweet-author"><a href="{{tweet.twitterUserLink}}" target="_blank" title="View user on twitter">{{tweet.userScreenName}}</a>\n                           <a href="{{tweet.twitterLink}}" target="_blank" title="View on twitter" class="tweet-twitter-link"></a>\n                       </div>\n           			<div class="tweet-text" ng-bind-html="tweet.getTextPretty"></div>\n           		</div>\n           		<div class="tweet-info">\n		           		<div class="tweet-statistic-icons">\n           				<span class="tweet-retweet-icon">{{tweet.retweetCount}}</span>\n           				<span  class="tweet-favorite-icon">{{tweet.favoriteCount}}</span>\n           			</div>\n           			<div class="tweet-date">{{tweet.createdAtFormatted}}</div>\n           		</div>\n               </div>\n           </div>\n        </section>\n        <section class="yucca-stream-tweet-stats-toolbar">\n            <a href ng-click="panel=\'chart\'" ng-class="{active: panel == \'chart\'}">Statistics</a> | <a href ng-click="panel=\'lastTweet\'" ng-class="{active: panel == \'lastTweet\'}">Last Tweet</a> | <a href ng-click="panel=\'mostRetweet\'" ng-class="{active: panel == \'mostRetweet\'}">Most Retweet</a> \n        </section>\n    </div>\n    <footer>\n        <div class="yucca-credits-intro">powered by</div>\n        <a href="http://www.smartdatanet.it/" target="_blank">\n          <i>SmartDataNet.it</i>\n        </a>\n    </footer>\n</div>\n')}]);